<!doctype html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thunder 전적검색 · LoL Summoner Lookup</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script>
    tailwind = {}; /* silence undefined in some browsers */
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","Pretendard","Noto Sans KR","system-ui","sans-serif"] },
          colors: { bg:"#0b1020", panel:"#111827", border:"#1f2937", brand:{500:"#60a5fa",600:"#3b82f6"} },
          boxShadow: { soft: "0 10px 30px rgba(0,0,0,.25)" },
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-boxplot@4.4.0/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>

  <!-- 🔧 플러그인 컨트롤러 등록(박스플롯/매트릭스) -->
  <script>
    (function () {
      try {
        const bp = window["chartjs-chart-boxplot"] || window.ChartBoxPlot || window.chartjsChartBoxplot || {};
        if (bp.BoxPlotController) Chart.register(bp.BoxPlotController, bp.BoxAndWhiskers, bp.ViolinController, bp.Violin);
      } catch (e) { console.warn("BoxPlot register failed:", e); }
      try {
        const mx = window["chartjs-chart-matrix"] || window.ChartMatrix || window.chartjsChartMatrix || {};
        if (mx.MatrixController) Chart.register(mx.MatrixController, mx.MatrixElement);
      } catch (e) { console.warn("Matrix register failed:", e); }
    })();
  </script>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='52' x='6' font-size='56'%3E%E2%9A%A1%EF%B8%8F%3C/text%3E%3C/svg%3E" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 600px at 20% -10%, #1e293b 0, transparent 60%),
        radial-gradient(800px 400px at 100% 0%, #0f172a 0, transparent 60%),
        #0b1020;
    }
    .card{@apply bg-panel/60 border border-border rounded-2xl shadow-soft}
    .btn{@apply inline-flex items-center justify-center font-semibold rounded-xl px-4 h-11 transition active:translate-y-px}
    .btn-primary{@apply bg-brand-500 hover:bg-brand-600 text-[#0b1020]}
    .pill{@apply px-3 py-2 rounded-full border border-border bg-white/5 text-white/90 hover:shadow}
    .pill-active{@apply ring-2 ring-brand-500/50 border-brand-500}
    .muted{@apply text-white/60}
    table.simple{ @apply w-full text-sm; border-collapse: collapse; }
    table.simple th, table.simple td{ @apply border border-border px-2 py-1 text-left; }
    table.simple th{ @apply bg-white/5 }
  </style>
</head>
<body class="text-white/95 font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur bg-slate-900/70 border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-lg font-extrabold"><span>⚡</span><span data-i18n="title">Thunder 전적검색</span></div>
      <div class="flex items-center gap-2">
        <button id="btn-share" class="pill" title="Share">🔗</button>
        <button id="btn-export" class="pill" title="Export CSV">📄</button>
        <button id="btn-save-charts" class="pill" title="Save Charts PNG">📷</button>
        <button id="btn-theme" class="pill" title="Brand Theme">🎨</button>
        <button id="btn-chart-theme" class="pill" title="Chart Theme">🌓 <span id="chart-theme-code" class="ml-1 text-xs">AUTO</span></button>
        <button id="btn-lang" class="pill" title="Language">🌐 <span id="lang-code" class="ml-1 text-xs">KO</span></button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <!-- Search & Compare -->
    <section class="card p-5 space-y-3">
      <h2 class="text-lg font-semibold" data-i18n="searchTitle">소환사 검색</h2>
      <form id="search-form" class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3" autocomplete="off" role="search">
        <input id="summoner-name" class="w-full bg-[#0b1220] border border-border rounded-xl px-4 h-11 outline-none focus:ring-2 focus:ring-brand-500"
               placeholder="Hide on bush#KR1" aria-label="Summoner or Riot ID" />
        <button type="submit" class="btn btn-primary" data-i18n="searchBtn">검색</button>
      </form>
      <details class="mt-1">
        <summary class="cursor-pointer muted text-sm">+ 비교 모드</summary>
        <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3 mt-2">
          <input id="compare-name" class="w-full bg-[#0b1220] border border-border rounded-xl px-4 h-11 outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="상대 소환사 또는 Riot ID" aria-label="Compare Summoner or Riot ID" />
          <button id="btn-compare" class="btn pill bg-white/10 hover:bg-white/20">비교</button>
        </div>
      </details>
      <p class="muted text-sm" data-i18n="searchHint">최근 5판 기반 KDA/승패/챔피언/모드/시간과 랭크 정보를 제공합니다.</p>
    </section>

    <!-- Filters -->
    <section class="card p-4">
      <div id="filter-bar" class="flex flex-wrap gap-2">
        <button type="button" class="pill pill-active" data-filter="ALL" data-i18n="fAll">전체</button>
        <button type="button" class="pill" data-filter="RANKED_SOLO_5x5" data-i18n="fSolo">솔로랭크</button>
        <button type="button" class="pill" data-filter="RANKED_FLEX_SR" data-i18n="fFlex">자유랭크</button>
        <button type="button" class="pill" data-filter="NORMAL" data-i18n="fNormal">일반</button>
        <button type="button" class="pill" data-filter="ARAM" data-i18n="fAram">ARAM</button>
      </div>
    </section>

    <!-- Recent -->
    <section id="recent-wrap" class="card p-4 hidden">
      <h3 class="text-base font-semibold mb-2" data-i18n="recent">최근 검색</h3>
      <ul id="recent-list" class="flex flex-wrap gap-2"></ul>
    </section>

    <!-- Stats -->
    <section id="stats" class="card p-5 hidden">
      <h3 class="text-base font-semibold mb-4" data-i18n="statsTitle">요약 통계</h3>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2" data-i18n="statWinrate">승률</div>
          <canvas id="chart-winrate" width="360" height="180"></canvas>
        </div>
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2" data-i18n="statRole">포지션 분포</div>
          <canvas id="chart-roles" width="360" height="180"></canvas>
        </div>
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2" data-i18n="statTrend">승률 추이(시간)</div>
          <canvas id="chart-trend" width="360" height="180"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="p-3 border border-border rounded-xl">
          <div class="flex items-center justify-between">
            <div class="muted mb-2" data-i18n="statChamp">챔피언 성과 Top N</div>
            <div class="flex items-center gap-2 text-sm muted">
              <label for="topN">N</label>
              <input id="topN" type="number" min="3" max="15" value="7" class="w-16 bg-[#0b1220] border border-border rounded px-2 py-1" />
            </div>
          </div>
          <canvas id="chart-champs" width="360" height="220"></canvas>
        </div>
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2" data-i18n="statKDA">KDA 분포(박스플롯)</div>
          <canvas id="chart-kda" width="360" height="220"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2">라인별 승률 추이</div>
          <canvas id="chart-role-trend" width="360" height="220"></canvas>
        </div>
        <div class="p-3 border border-border rounded-xl">
          <div class="flex items-center justify-between">
            <div class="muted mb-2">챔피언 KDA 히트맵</div>
            <div class="flex items-center gap-2">
              <label class="muted text-xs">축</label>
              <select id="heat-axes" class="bg-[#0b1220] border border-border rounded px-2 py-1 text-xs">
                <option value="champ-queue">Champion × Queue</option>
                <option value="queue-champ">Queue × Champion</option>
              </select>
            </div>
          </div>
          <canvas id="chart-heatmap" width="360" height="220"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2">시간대별 승률(현지)</div>
          <canvas id="chart-hourly" width="360" height="220"></canvas>
        </div>
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2">아이템 빌드 빈도(Top 12)</div>
          <div id="items-cloud" class="flex flex-wrap gap-2"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2">라인별 KDA 평균</div>
          <table id="role-kda-table" class="simple">
            <thead><tr><th>라인</th><th>평균 KDA</th><th>게임 수</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="p-3 border border-border rounded-xl">
          <div class="muted mb-2">아이템 빌드 클러스터</div>
          <div id="items-clusters" class="flex flex-col gap-2"></div>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="result" class="card p-5" aria-live="polite">
      <div class="muted" data-i18n="empty">위 입력창에 소환사명을 입력해 주세요.</div>
    </section>

    <!-- Pagination / Health -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card p-4 flex items-center justify-between gap-3">
        <div class="muted text-sm" data-i18n="moreHint">더 많은 경기를 불러옵니다.</div>
        <button id="btn-more" class="btn pill bg-white/10 hover:bg-white/20" disabled data-i18n="moreBtn">더 보기 (+5)</button>
      </div>
      <div class="card p-4">
        <h3 class="text-base font-semibold mb-2" data-i18n="healthTitle">연결 상태 점검</h3>
        <div class="flex items-center gap-3 flex-wrap">
          <button class="btn pill bg-white/10 hover:bg-white/20" id="btn-health" data-i18n="healthBtn">/health 체크</button>
          <span id="health-state" class="muted text-sm"></span>
        </div>
      </div>
    </section>

    <footer class="muted text-sm pt-2 pb-6">
      <div>© Thunder. Not affiliated with Riot Games. <span data-i18n="policy">플랫폼 외 결제/연락처 공유 금지(안티 포칭).</span></div>
      <div>Front: GitHub Pages · Back: <code>https://cjsend.erickparkcha.workers.dev</code></div>
    </footer>
  </main>

  <!-- ===== 앱 로직 (기존 app.js 전체 내장) ===== -->
  <script>
  /* == 설정 == */
  const API_BASE = "https://cjsend.erickparkcha.workers.dev";
  const STORAGE = { hist:"thunder_recent_searches", lang:"thunder_lang", theme:"thunder_theme", chartTheme:"thunder_chart_theme", heatAxes:"thunder_heat_axes" };
  const MAX_HISTORY = 8;
  let DDRAGON_VER = "latest";
  (async()=>{ try{ const r=await fetch("https://ddragon.leagueoflegends.com/api/versions.json"); const j=await r.json(); if(Array.isArray(j)&&j.length) DDRAGON_VER=j[0]; }catch{} })();

  /* == i18n, 테마, 차트테마 == */
  const i18n = {
    ko:{ title:"Thunder 전적검색", searchTitle:"소환사 검색", searchBtn:"검색", searchHint:"최근 5판 기반 KDA/승패/챔피언/모드/시간과 랭크 정보를 제공합니다.",
      fAll:"전체", fSolo:"솔로랭크", fFlex:"자유랭크", fNormal:"일반", fAram:"ARAM", recent:"최근 검색", empty:"위 입력창에 소환사명을 입력해 주세요.",
      healthTitle:"연결 상태 점검", healthBtn:"/health 체크", level:(n)=>\`레벨 \${n}\`, solo:"솔로랭크", flex:"자유랭크", unranked:"언랭크",
      cached:"결과는 최대 45초 캐시됨", coachCta:"코칭 문의", policy:"플랫폼 외 결제/연락처 공유 금지(안티 포칭).",
      errTitle:"에러", errLoad:"프로필을 불러오지 못했습니다.", statsTitle:"요약 통계", statWinrate:"승률", statRole:"포지션 분포",
      statTrend:"승률 추이(시간)", statChamp:"챔피언 성과 Top N", statKDA:"KDA 분포(박스플롯)", moreBtn:"더 보기 (+5)", moreHint:"더 많은 경기를 불러옵니다." },
    en:{ title:"Thunder Stats Lookup", searchTitle:"Summoner Search", searchBtn:"Search", searchHint:"Shows last 5 games (KDA/W-L/Champion/Mode/Time) and ranked info.",
      fAll:"All", fSolo:"Ranked Solo", fFlex:"Ranked Flex", fNormal:"Normal", fAram:"ARAM", recent:"Recent Searches", empty:"Enter a Summoner name or Riot ID above.",
      healthTitle:"Connectivity Check", healthBtn:"Check /health", level:(n)=>\`Level \${n}\`, solo:"Ranked Solo", flex:"Ranked Flex", unranked:"Unranked",
      cached:"Results cached up to 45s", coachCta:"Ask for Coaching", policy:"No off-platform payments or contact sharing (anti-poaching).",
      errTitle:"Error", errLoad:"Failed to load profile.", statsTitle:"Summary Stats", statWinrate:"Win Rate", statRole:"Role Distribution",
      statTrend:"Winrate Over Time", statChamp:"Top Champions", statKDA:"KDA Distribution (Boxplot)", moreBtn:"Load More (+5)", moreHint:"Fetch more recent matches." }
  };
  let LANG = localStorage.getItem(STORAGE.lang) || (new URL(location.href).searchParams.get("lang") || "ko");
  function applyLang(){ const d=i18n[LANG]||i18n.ko; document.documentElement.lang = LANG==="en"?"en":"ko";
    document.querySelectorAll("[data-i18n]").forEach(el=>{ const k=el.dataset.i18n; const v=d[k]; if(typeof v==="string") el.textContent=v; });
    document.getElementById("lang-code")?.replaceChildren(document.createTextNode(LANG.toUpperCase())); }
  applyLang();

  let THEME = localStorage.getItem(STORAGE.theme) || (new URL(location.href).searchParams.get("theme") || "blue");
  const BRAND = { blue:{500:"#60a5fa",600:"#3b82f6"}, violet:{500:"#a78bfa",600:"#8b5cf6"}, emerald:{500:"#34d399",600:"#10b981"} };
  function hexToRgba(hex,a){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return hex; const r=parseInt(m[1],16),g=parseInt(m[2],16),b=parseInt(m[3],16); return \`rgba(\${r},\${g},\${b},\${a})\`; }
  function applyBrandTheme(){ const b=BRAND[THEME]||BRAND.blue; document.getElementById("brand-override")?.remove();
    const s=document.createElement("style"); s.id="brand-override";
    s.textContent = \`.btn-primary{background:\${b[500]}}.btn-primary:hover{background:\${b[600]}}.pill-active{box-shadow:0 0 0 4px \${hexToRgba(b[500],.35)};border-color:\${b[500]}}\`;
    document.head.appendChild(s); }
  applyBrandTheme();

  let CHART_THEME = localStorage.getItem(STORAGE.chartTheme) || "auto";
  const mediaDark = window.matchMedia?.("(prefers-color-scheme: dark)");
  function isDarkMode(){ if (CHART_THEME === "dark") return true; if (CHART_THEME === "light") return false; return !!mediaDark?.matches; }
  function chartColors(){ const dark = isDarkMode(); return {
    text: dark ? "#e5e7eb" : "#111827",
    grid: dark ? "rgba(255,255,255,.15)" : "rgba(17,24,39,.15)",
    heatCell: dark ? (v)=>\`rgba(255,255,255,\${Math.min(0.15 + v/10*0.85,1)})\` : (v)=>\`rgba(0,0,0,\${Math.min(0.08 + v/12*0.75,0.9)})\`,
  }; }
  function applyChartThemeGlobals(){ const c=chartColors(); Chart.defaults.color = c.text; Chart.defaults.borderColor = c.grid; }
  applyChartThemeGlobals();
  document.getElementById("chart-theme-code")?.replaceChildren(document.createTextNode(CHART_THEME.toUpperCase()));
  mediaDark?.addEventListener?.("change", ()=>{ if(CHART_THEME==="auto" && out._accum){ applyChartThemeGlobals(); renderCharts(out._accum); } });

  /* == DOM & helpers == */
  const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const form=$("#search-form"), input=$("#summoner-name"), out=$("#result"), filterBar=$("#filter-bar");
  const recentWrap=$("#recent-wrap"), recentList=$("#recent-list");
  const statsSec=$("#stats"), moreBtn=$("#btn-more"), topNEl=$("#topN");
  const btnShare=$("#btn-share"), btnExport=$("#btn-export"), btnSaveCharts=$("#btn-save-charts");
  const compareInput=$("#compare-name"), btnCompare=$("#btn-compare");
  const itemsCloud=$("#items-cloud"), itemsClusters=$("#items-clusters");
  const roleKDATBody = $("#role-kda-table tbody");
  const heatAxesSel=$("#heat-axes");

  const safe=(v)=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const fmtDuration=(sec)=>{ if(!sec||isNaN(sec))return"-:--"; const m=Math.floor(sec/60), s=Math.floor(sec%60); return \`\${m}:\${String(s).padStart(2,"0")}\`; };
  const timeAgo=(ms)=>{ const t=Date.now()-(ms||0); const m=Math.floor(t/60000); if(m<1) return LANG==="en"?"just now":"방금 전"; if(m<60) return LANG==="en"?\`\${m}m ago\`:\`\${m}분 전\`; const h=Math.floor(m/60); if(h<24) return LANG==="en"?\`\${h}h ago\`:\`\${h}시간 전\`; const d=Math.floor(h/24); return LANG==="en"?\`\${d}d ago\`:\`\${d}일 전\`; };
  function rankLine(e){ const d=i18n[LANG]; if(!e) return \`<span class="muted">\${d.unranked}</span>\`; const lp=typeof e.leaguePoints==="number"?\`\${e.leaguePoints}LP\`:""; const wr=e.wins+e.losses>0?\` · \${Math.round((e.wins/(e.wins+e.losses))*100)}%\`:""; const tier=String(e.tier||"").toLowerCase().replace(/^\w/,c=>c.toUpperCase()); return \`<b>\${tier} \${e.rank}</b> \${lp}\${wr}\`; }
  function withRing(on){ if(on) form.classList.add("ring-2","ring-brand-500/50"); else form.classList.remove("ring-2","ring-brand-500/50"); }

  function getHistory(){ try{return JSON.parse(localStorage.getItem(STORAGE.hist)||"[]")}catch{return[]} }
  function saveHistory(n){ n=n.trim(); if(!n) return; const arr=getHistory().filter(x=>x.toLowerCase()!==n.toLowerCase()); arr.unshift(n); while(arr.length>MAX_HISTORY)arr.pop(); localStorage.setItem(STORAGE.hist, JSON.stringify(arr)); renderHistory(); }
  function removeHistory(n){ const arr=getHistory().filter(x=>x.toLowerCase()!==n.toLowerCase()); localStorage.setItem(STORAGE.hist, JSON.stringify(arr)); renderHistory(); }
  function renderHistory(){ const arr=getHistory(); if(!arr.length){ recentWrap.classList.add("hidden"); return; } recentWrap.classList.remove("hidden"); recentList.innerHTML=arr.map(n=>\`<li class="flex items-center gap-1 border border-border rounded-full px-3 py-1 bg-white/5"><button class="text-sm" data-name="\${safe(n)}">\${safe(n)}</button><button class="text-white/60 hover:text-white" title="삭제" data-del="\${safe(n)}">×</button></li>\`).join(""); }

  let currentFilter = new URL(location.href).searchParams.get("queue")?.toUpperCase() || "ALL";
  function setFilterUI(){ $$("#filter-bar .pill").forEach(b=>b.classList.toggle("pill-active", b.dataset.filter===currentFilter)); }
  filterBar?.addEventListener("click", (e)=>{ const b=e.target.closest("[data-filter]"); if(!b) return; currentFilter=b.dataset.filter; setFilterUI(); if(out._raw) renderProfile(out._raw,{filter:currentFilter}); syncURL(); });

  let currentName = ""; let loadedCount = 0;
  async function fetchProfile(name, count=5, queue="ALL", start=0){
    const url = \`\${API_BASE}/profile?name=\${encodeURIComponent(name)}&count=\${count}&queue=\${encodeURIComponent(queue)}&start=\${start}\`;
    const res = await fetch(url); const json = await res.json().catch(()=> ({}));
    if(!res.ok || json.error){ const err=typeof json.error==="string"?json.error:JSON.stringify(json.error||json); throw new Error(err||\`HTTP \${res.status}\`); }
    return json;
  }

  let ITEM_DICT = null;
  async function ensureItemDict(){
    if (ITEM_DICT) return ITEM_DICT;
    const locale = LANG==="en" ? "en_US" : "ko_KR";
    try{
      const r = await fetch(\`https://ddragon.leagueoflegends.com/cdn/\${DDRAGON_VER}/data/\${locale}/item.json\`);
      const j = await r.json();
      ITEM_DICT = j?.data || {};
    }catch{ ITEM_DICT = {}; }
    return ITEM_DICT;
  }
  const itemIconURL = id => \`https://ddragon.leagueoflegends.com/cdn/\${DDRAGON_VER}/img/item/\${id}.png\`;

  let chartWin=null, chartRoles=null, chartTrend=null, chartChamps=null, chartKDA=null, chartRoleTrend=null, chartHeatmap=null, chartHourly=null;
  let HEAT_AXES = localStorage.getItem(STORAGE.heatAxes) || "champ-queue";
  heatAxesSel && (heatAxesSel.value = HEAT_AXES);

  function renderRoleKDATable(items){
    const roles = ["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"];
    const rows = roles.map(r=>{
      const arr = items.filter(m=>(m.role||"").toUpperCase()===r);
      const kd = arr.map(m=>{
        const [k,d,a] = (m.kda?.match(/^(\d+)\/(\d+)\/(\d+)/)||[]).slice(1,4).map(x=>parseInt(x||"0",10));
        return d===0? (k+a) : (k+a)/d;
      });
      const avg = kd.length ? (kd.reduce((s,v)=>s+v,0)/kd.length).toFixed(2) : "-";
      return \`<tr><td>\${r}</td><td>\${avg}</td><td>\${arr.length}</td></tr>\`;
    }).join("");
    roleKDATBody.innerHTML = rows;
  }

  async function renderItemsCloud(items){
    itemsCloud.innerHTML = "";
    const dict = await ensureItemDict();
    const freq = {};
    for (const m of items) for (const id of (m.items||[])) if(id) freq[id]=(freq[id]||0)+1;
    const top = Object.entries(freq).sort((a,b)=> b[1]-a[1]).slice(0, 12);
    if (!top.length) { itemsCloud.innerHTML = \`<div class="muted text-sm">데이터 없음</div>\`; return; }
    itemsCloud.innerHTML = top.map(([id,c])=>{
      const meta = dict[id] || {}, name = meta.name || id;
      return \`<div class="flex items-center gap-2 border border-border rounded-xl px-2 py-1 bg-black/30" title="\${safe(name)} ×\${c}">
        <img src="\${itemIconURL(id)}" alt="\${safe(name)}" class="w-8 h-8 rounded" />
        <div class="text-sm">\${safe(name)} <span class="muted">×\${c}</span></div>
      </div>\`;
    }).join("");
  }

  function clusterBuilds(items){
    const builds = items.map(m => Array.from(new Set((m.items||[]).filter(Boolean))).sort((a,b)=>a-b)).filter(a=>a.length);
    const clusters = [];
    const sim = (a,b)=>{
      const A=new Set(a), B=new Set(b);
      let inter=0; for(const x of A) if(B.has(x)) inter++;
      const uni = A.size + B.size - inter;
      return uni? inter/uni : 0;
    };
    for (const b of builds){
      let placed=false;
      for (const c of clusters){
        if (sim(c.rep, b) >= 0.5){ c.items.push(b);
          const f={}; for(const arr of c.items) for(const id of arr) f[id]=(f[id]||0)+1;
          c.rep = Object.entries(f).sort((x,y)=>y[1]-x[1]).map(([id])=>+id).slice(0,6);
          placed=true; break;
        }
      }
      if(!placed) clusters.push({ rep:[...b], items:[b] });
    }
    return clusters.sort((a,b)=> b.items.length - a.items.length);
  }
  async function renderItemClusters(items){
    itemsClusters.innerHTML = "";
    const dict = await ensureItemDict();
    const clusters = clusterBuilds(items).slice(0,5);
    if(!clusters.length){ itemsClusters.innerHTML = \`<div class="muted text-sm">데이터 없음</div>\`; return; }
    itemsClusters.innerHTML = clusters.map((c,idx)=>{
      const rep = c.rep.map(id=>{
        const name = dict[id]?.name || id;
        return \`<div class="flex items-center gap-1" title="\${safe(name)}">
          <img src="\${itemIconURL(id)}" class="w-6 h-6 rounded" alt="\${safe(name)}"><span class="text-xs">\${safe(String(name).slice(0,10))}</span>
        </div>\`;
      }).join("");
      return \`<div class="border border-border rounded-xl p-2 bg-black/30">
        <div class="text-xs muted mb-1">Cluster \${idx+1} · \${c.items.length} games</div>
        <div class="flex flex-wrap gap-2">\${rep}</div>
      </div>\`;
    }).join("");
  }

  function renderCharts(items){
    if(!items?.length){ statsSec.classList.add("hidden"); return; }
    statsSec.classList.remove("hidden");
    applyChartThemeGlobals();
    const colors = chartColors();

    const wins = items.filter(m=>m.win).length, losses = items.length - wins;
    chartWin?.destroy();
    chartWin = new Chart($("#chart-winrate"), {
      type: "doughnut",
      data: { labels:[LANG==="en"?"Win":"승", LANG==="en"?"Loss":"패"], datasets:[{ data:[wins,losses] }] },
      options: { plugins:{ legend:{ labels:{ color: colors.text } } } }
    });

    const roles = ["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"];
    const counts = roles.map(r=> items.filter(x=>(x.role||"").toUpperCase()===r).length );
    chartRoles?.destroy();
    chartRoles = new Chart($("#chart-roles"), {
      type: "bar",
      data: { labels: roles, datasets:[{ data: counts }] },
      options: { scales:{ x:{ ticks:{ color:colors.text} }, y:{ ticks:{ color:colors.text} } }, plugins:{ legend:{ display:false } } }
    });

    const sorted = [...items].sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
    let cumW=0;
    const trendLabels = sorted.map((m)=> new Date(m.timestamp||0).toLocaleDateString());
    const trendData = sorted.map((m,i)=> { if(m.win) cumW++; return Math.round((cumW/ (i+1))*100); });
    chartTrend?.destroy();
    chartTrend = new Chart($("#chart-trend"), {
      type: "line",
      data: { labels: trendLabels, datasets:[{ data: trendData }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:colors.text} }, y:{ ticks:{ color:colors.text} } } }
    });

    const topN = Math.min(Math.max(parseInt($("#topN")?.value || "7", 10), 3), 15);
    const byChamp = {};
    for (const m of items){ const c = m.champion || "Unknown"; byChamp[c] ??= { games:0, wins:0 }; byChamp[c].games++; if(m.win) byChamp[c].wins++; }
    const champs = Object.entries(byChamp).sort((a,b)=> b[1].games - a[1].games).slice(0, topN);
    const champLabels = champs.map(([c])=>c);
    const champWR = champs.map(([c, s])=> Math.round((s.wins / s.games) * 100));
    chartChamps?.destroy();
    chartChamps = new Chart($("#chart-champs"), {
      type: "bar",
      data: { labels: champLabels, datasets:[{ data: champWR }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:colors.text} }, y:{ ticks:{ color:colors.text} } } }
    });

    const kdas = items.map(m=>{
      const [k,d,a] = (m.kda?.match(/^(\d+)\/(\d+)\/(\d+)/)||[]).slice(1,4).map(x=>parseInt(x||"0",10));
      const v = d===0 ? (k+a) : (k+a)/d; return Number.isFinite(v)? v : 0;
    }).filter(x=>x>=0);
    const bp = (arr)=>{ if(!arr.length) return {min:0,q1:0,median:0,q3:0,max:0}; const a=[...arr].sort((x,y)=>x-y); const q=p=>a[Math.floor((a.length-1)*p)]; return {min:a[0],q1:q(0.25),median:q(0.5),q3:q(0.75),max:a[a.length-1] }; }
    try{
      chartKDA?.destroy();
      chartKDA = new Chart($("#chart-kda"), {
        type: "boxplot",
        data: { labels:["KDA"], datasets:[{ data:[bp(kdas)] }] },
        options: { plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:colors.text} }, y:{ ticks:{ color:colors.text} } } }
      });
    } catch (e) {
      console.warn("Boxplot unavailable, fallback to histogram:", e);
      const bins = [0,1,2,3,4,5,7,10];
      const hist = new Array(bins.length - 1).fill(0);
      kdas.forEach(v=>{ for (let i=0;i<bins.length-1;i++) if (v>=bins[i] && v<bins[i+1]) { hist[i]++; return; }});
      const labels = bins.slice(0,-1).map((b,i)=> \`\${b}–\${bins[i+1]}\`);
      chartKDA?.destroy();
      chartKDA = new Chart($("#chart-kda"), {
        type: "bar",
        data: { labels, datasets: [{ data: hist }] },
        options: { plugins:{ legend:{ display: false } }, scales:{ x:{ ticks:{ color:colors.text} }, y:{ ticks:{ color:colors.text} } } }
      });
    }

    const roleSeries = {}; const timeLabels = sorted.map(m=> new Date(m.timestamp||0).toLocaleDateString());
    const roles2 = ["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"]; for (const r of roles2) roleSeries[r] = { cum:0, cnt:0, ys:[] };
    for (const m of sorted){ const r = (m.role||"").toUpperCase();
      for (const R of roles2){ if (R===r) { roleSeries[R].cnt++; if(m.win) roleSeries[R].cum++; } roleSeries[R].ys.push(roleSeries[R].cnt? Math.round((roleSeries[R].cum/roleSeries[R].cnt)*100) : null); } }
    chartRoleTrend?.destroy();
    chartRoleTrend = new Chart($("#chart-role-trend"), {
      type: "line",
      data: { labels: timeLabels, datasets: roles2.map(R=>({ label:R, data: roleSeries[R].ys, spanGaps:true })) },
      options: { scales:{ x:{ ticks:{ color:colors.text} }, y:{ ticks:{ color:colors.text} } } }
    });

    const queues = ["RANKED_SOLO_5x5","RANKED_FLEX_SR","ARAM","NORMAL"];
    const topMap = {}; for (const m of items){ const c = m.champion || "Unknown"; topMap[c]=(topMap[c]||0)+1; }
    const topChamps = Object.entries(topMap).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([c])=>c);

    const kdaBy = {}; for (const c of topChamps){ kdaBy[c]={}; for (const q of queues) kdaBy[c][q]=[]; }
    for (const m of items){
      const c=m.champion||"Unknown"; if(!topChamps.includes(c)) continue;
      const q=(m.queueType|| (m.gameMode==="CLASSIC" ? "NORMAL" : "NORMAL"));
      const [k,d,a] = (m.kda?.match(/^(\d+)\/(\d+)\/(\d+)/)||[]).slice(1,4).map(x=>parseInt(x||"0",10));
      const v=d===0?(k+a):(k+a)/d;
      const key= queues.includes(q)? q : "NORMAL";
      kdaBy[c][key].push(v);
    }
    const cfun = chartColors().heatCell; const dataMatrix = []; let xLabels=[], yLabels=[];
    if (localStorage.getItem(STORAGE.heatAxes) || "champ-queue" === "champ-queue") {}
    if (HEAT_AXES === "champ-queue"){ xLabels = queues; yLabels = topChamps;
      topChamps.forEach((c,y)=> queues.forEach((q,x)=>{
        const arr=kdaBy[c][q]; const val=arr.length? Math.round((arr.reduce((s,v)=>s+v,0)/arr.length)*100)/100 : 0;
        dataMatrix.push({ x, y, v:val });
      }));
    } else { xLabels = topChamps; yLabels = queues;
      queues.forEach((q,y)=> topChamps.forEach((c,x)=>{
        const arr=kdaBy[c][q]; const val=arr.length? Math.round((arr.reduce((s,v)=>s+v,0)/arr.length)*100)/100 : 0;
        dataMatrix.push({ x, y, v:val });
      }));
    }
    chartHeatmap?.destroy();
    chartHeatmap = new Chart($("#chart-heatmap"), {
      type: "matrix",
      data: { datasets: [{ data: dataMatrix,
        width: ({chart}) => (chart.chartArea?.width||360)/xLabels.length - 6,
        height: ({chart}) => (chart.chartArea?.height||220)/yLabels.length - 6,
        backgroundColor: ctx => cfun(ctx.raw.v||0), borderColor: chartColors().grid, borderWidth: 1 }]},
      options: { plugins: { legend: { display:false }, tooltip: { callbacks:{ title:(it)=>\`\${yLabels[it[0].raw.y]} × \${xLabels[it[0].raw.x]}\`, label:(it)=>\`KDA \${it.raw.v}\` } } },
        scales: { x: { ticks:{ color:chartColors().text, callback:(v)=>xLabels[v] }, grid:{ display:false } },
                  y: { ticks:{ color:chartColors().text, callback:(v)=>yLabels[v] }, grid:{ display:false } } } }
    });

    const byHour = Array.from({length:24}, ()=>({w:0,c:0}));
    for (const m of items){ const d = new Date(m.timestamp||0); const hour = d.getHours(); byHour[hour].c++; if(m.win) byHour[hour].w++; }
    const wrByHour = byHour.map(x=> x.c ? Math.round((x.w/x.c)*100) : 0);
    chartHourly?.destroy();
    chartHourly = new Chart($("#chart-hourly"), {
      type: "bar",
      data: { labels: [...Array(24).keys()].map(h=>\`\${h}:00\`), datasets:[{ data: wrByHour }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:chartColors().text} }, y:{ ticks:{ color:chartColors().text} } } }
    });

    renderItemsCloud(items); renderItemClusters(items); renderRoleKDATable(items);
  }

  function renderLoading(){ out.innerHTML = \`<div class="animate-pulse text-white/70">Loading…</div>\`; }
  function renderError(msg, debug=""){ const d=i18n[LANG]; out.innerHTML = \`<div class="border-l-4 border-red-500 bg-red-500/10 rounded-xl p-4"><div class="font-semibold mb-1">\${d.errTitle}</div><div>\${safe(msg)}</div>\${debug?\`<pre class="mt-2 text-xs text-white/70 whitespace-pre-wrap">\${safe(debug)}</pre>\`:""}</div>\`; statsSec.classList.add("hidden"); moreBtn.disabled=true; }
  function renderProfile(data, opts={}){ const s=data.summoner||{}, r=data.rank||{}; const solo=r.solo, flex=r.flex;
    let items=data.summary||[]; const f=(opts.filter||currentFilter||"ALL").toUpperCase();
    if(f!=="ALL"){ items=items.filter(m=>{ if(f==="RANKED_SOLO_5x5") return m.queueType==="RANKED_SOLO_5x5"; if(f==="RANKED_FLEX_SR") return m.queueType==="RANKED_FLEX_SR"; if(f==="NORMAL") return m.gameMode==="CLASSIC"&&!m.queueType; if(f==="ARAM") return m.gameMode==="ARAM"; return true; }); }
    if(Array.isArray(out._accum)) items = [...out._accum, ...items];

    const list = items.map(m=>{
      const champ=m.champion??"-";
      const icon=\`https://ddragon.leagueoflegends.com/cdn/\${DDRAGON_VER}/img/champion/\${champ}.png\`;
      return \`<li class="flex gap-3 items-center p-3 border border-border rounded-xl bg-black/30">
        <img class="rounded-lg w-10 h-10" src="\${icon}" alt="\${safe(champ)}" onerror="this.style.display='none'"/>
        <div class="flex-1 min-w-0">
          <div class="truncate"><b>\${m.win ? (LANG==="en"?"Win":"승") : (LANG==="en"?"Loss":"패")}</b> | \${safe(m.gameMode??"-")} | \${safe(champ)} • \${timeAgo(m.timestamp)}</div>
          <div class="text-white/60">📊 \${safe(m.kda)} · CS \${safe(m.cs??0)} · \${fmtDuration(m.time??0)}</div>
        </div>
      </li>\`;
    }).join("");

    out._raw = data; out._accum = items;
    out.innerHTML = \`
      <div class="space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h3 class="text-xl font-extrabold">\${safe(s.name??"-")}</h3>
            <div class="text-white/60">\${i18n[LANG].level(s.summonerLevel??"-")} • \${i18n[LANG].cached}</div>
          </div>
          <div class="grid grid-cols-2 gap-3 min-w-[260px]">
            <div class="border border-border rounded-xl p-3">
              <div class="text-white/60 text-sm mb-1">\${i18n[LANG].solo}</div>
              <div>\${rankLine(solo)}</div>
            </div>
            <div class="border border-border rounded-xl p-3">
              <div class="text-white/60 text-sm mb-1">\${i18n[LANG].flex}</div>
              <div>\${rankLine(flex)}</div>
            </div>
          </div>
        </div>
        <ul class="grid gap-2">\${list || \`<li class="text-white/60">\${i18n[LANG].empty}</li>\`}</ul>
        <div class="flex items-center gap-3 flex-wrap">
          <button id="cta-coach" class="btn pill bg-white/10 hover:bg-white/20">\${i18n[LANG].coachCta}</button>
          <span class="text-white/60 text-sm">\${i18n[LANG].policy}</span>
        </div>
      </div>\`;
    document.getElementById("cta-coach")?.addEventListener("click", ()=> alert(LANG==="en"?"Coaching is coming soon!":"코칭 문의는 곧 오픈됩니다!"));

    renderCharts(items); moreBtn.disabled = false;
  }

  function toCSV(items){
    const header = ["matchId","mode","queue","champion","win","k","d","a","kda","cs","timeSec","timestamp","role","items"];
    const rows = items.map(m=>{
      const [k,d,a] = (m.kda?.match(/^(\d+)\/(\d+)\/(\d+)/)||[]).slice(1,4);
      return [ m.gameId, m.gameMode, m.queueType, m.champion, m.win ? 1:0, k||0, d||0, a||0,
        (m.kda||"").split(" ").slice(-1)[0], m.cs||0, m.time||0, m.timestamp||0, m.role||"", (m.items||[]).join("|") ]
        .map(v=>String(v).replace(/"/g,'""'));
    });
    return [header, ...rows].map(r=>r.map(x=>`"${x}"`).join(",")).join("\n");
  }
  function download(filename, content, mime="text/plain"){
    const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function syncURL(){ const u=new URL(location.href);
    u.searchParams.set("q", currentName||""); u.searchParams.set("queue", currentFilter||"ALL");
    u.searchParams.set("lang", LANG); u.searchParams.set("theme", THEME);
    history.replaceState(null, "", u.toString()); }

  document.getElementById("btn-save-charts")?.addEventListener("click", ()=>{
    const canvases = statsSec?.querySelectorAll("canvas") || []; let i=1;
    canvases.forEach(cv=>{ try{ const url=cv.toDataURL("image/png"); const a=document.createElement("a"); a.href=url; a.download=`thunder_chart_${i++}.png`; document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),0); }catch{} });
  });
  document.getElementById("btn-export")?.addEventListener("click", ()=>{
    if(!out._accum?.length) return; const csv = toCSV(out._accum);
    download(`thunder_${(currentName||"player").replace(/\W+/g,"_")}.csv`, csv, "text/csv;charset=utf-8");
  });
  document.getElementById("btn-share")?.addEventListener("click", async ()=>{
    const u=new URL(location.href); if(currentName) u.searchParams.set("q", currentName);
    u.searchParams.set("queue", currentFilter); u.searchParams.set("lang", LANG); u.searchParams.set("theme", THEME);
    const link=u.toString();
    try{ if(navigator.share) await navigator.share({ title:"Thunder", url:link });
      else { await navigator.clipboard.writeText(link); alert(LANG==="en"?"Link copied":"링크 복사됨"); } }catch{}
  });

  function setFilterAndRender(){ setFilterUI(); if(out._raw) renderProfile(out._raw,{filter:currentFilter}); }
  form?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const name=(input?.value||"").trim(); if(!name) return;
    currentName=name; loadedCount=0; out._accum=[]; withRing(true); renderLoading();
    try{ saveHistory(name); const data=await fetchProfile(name, 5, currentFilter, 0);
      loadedCount += (data.summary||[]).length; renderProfile(data); syncURL();
    }catch(err){ renderError(i18n[LANG].errLoad, String(err?.message||err)); } finally{ withRing(false); }
  });
  input?.addEventListener("keydown",(e)=>{ if(e.key==="Enter") form?.requestSubmit(); });
  recentList?.addEventListener("click",(e)=>{
    const btn=e.target.closest("[data-name]"); const del=e.target.closest("[data-del]");
    if(btn){ input.value=btn.dataset.name||""; form?.requestSubmit(); }
    if(del) removeHistory(del.dataset.del||"");
  });

  document.getElementById("btn-more")?.addEventListener("click", async ()=>{
    if(!currentName) return; const btn=document.getElementById("btn-more"); btn.disabled=true;
    try{ const data=await fetchProfile(currentName, 5, currentFilter, loadedCount);
      loadedCount += (data.summary||[]).length; if(out._accum) data.summary = [...out._accum, ...(data.summary||[])];
      renderProfile(data);
    }catch(err){ renderError(i18n[LANG].errLoad, String(err?.message||err)); } finally{ btn.disabled=false; }
  });

  document.getElementById("btn-health")?.addEventListener("click", async ()=>{
    const el=document.getElementById("health-state"); if(!el) return; el.textContent = LANG==="en"?"Checking…":"확인 중…";
    try{ const res=await fetch(`${API_BASE}/health`); const txt=await res.text(); el.textContent=res.ok?`OK: ${txt}`:`ERR ${res.status}: ${txt}`; }
    catch(e){ el.textContent=(LANG==="en"?"Failed: ":"요청 실패: ")+(e?.message||e); }
  });

  document.getElementById("btn-lang")?.addEventListener("click", ()=>{
    LANG = LANG==="en"?"ko":"en"; localStorage.setItem(STORAGE.lang, LANG); applyLang(); setFilterAndRender(); syncURL();
  });
  document.getElementById("btn-theme")?.addEventListener("click", ()=>{
    THEME = THEME==="blue"?"violet":THEME==="violet"?"emerald":"blue"; localStorage.setItem(STORAGE.theme, THEME); applyBrandTheme(); syncURL();
  });
  document.getElementById("btn-chart-theme")?.addEventListener("click", ()=>{
    CHART_THEME = CHART_THEME==="auto" ? "dark" : CHART_THEME==="dark" ? "light" : "auto";
    localStorage.setItem(STORAGE.chartTheme, CHART_THEME);
    document.getElementById("chart-theme-code")?.replaceChildren(document.createTextNode(CHART_THEME.toUpperCase()));
    applyChartThemeGlobals(); if(out._accum) renderCharts(out._accum);
  });

  heatAxesSel?.addEventListener("change", ()=>{
    localStorage.setItem(STORAGE.heatAxes, heatAxesSel.value || "champ-queue");
    HEAT_AXES = heatAxesSel.value || "champ-queue"; if(out._accum) renderCharts(out._accum);
  });

  document.getElementById("btn-compare")?.addEventListener("click", async ()=>{
    const nameA=(input?.value||"").trim(); const nameB=(compareInput?.value||"").trim();
    if(!nameA || !nameB) return alert(LANG==="en"?"Enter both names":"두 소환사를 모두 입력하세요");
    try{
      withRing(true); renderLoading();
      const [A,B] = await Promise.all([fetchProfile(nameA, 10, "ALL", 0), fetchProfile(nameB, 10, "ALL", 0)]);
      const cmp = (data)=>{
        const items=data.summary||[]; const wins = items.filter(m=>m.win).length;
        const wr = items.length? Math.round(wins/items.length*100) : 0;
        const kdavals = items.map(m=>{
          const [k,d,a] = (m.kda?.match(/^(\d+)\/(\d+)\/(\d+)/)||[]).slice(1,4).map(x=>parseInt(x||"0",10));
          return d===0 ? (k+a) : (k+a)/d; });
        const avgKDA = kdavals.length ? (kdavals.reduce((x,y)=>x+y,0)/kdavals.length).toFixed(2) : "0.00";
        return { wr, avgKDA, name:data.summoner?.name || "" };
      };
      const a=cmp(A), b=cmp(B);
      out.innerHTML = \`
        <div class="grid md:grid-cols-2 gap-4">
          <div class="border border-border rounded-2xl p-4"><h3 class="text-lg font-bold">\${safe(a.name)}</h3>
            <div class="mt-2">WR: <b>\${a.wr}%</b></div><div>Avg KDA: <b>\${a.avgKDA}</b></div></div>
          <div class="border border-border rounded-2xl p-4"><h3 class="text-lg font-bold">\${safe(b.name)}</h3>
            <div class="mt-2">WR: <b>\${b.wr}%</b></div><div>Avg KDA: <b>\${b.avgKDA}</b></div></div>
        </div><p class="muted mt-3">* 비교는 최근 10판 기준 간단 지표입니다.</p>\`;
      statsSec.classList.add("hidden");
    }catch(e){ renderError(i18n[LANG].errLoad, String(e?.message||e)); } finally{ withRing(false); }
  });

  topNEl?.addEventListener("change", ()=>{ if(out._accum?.length) renderCharts(out._accum); });

  (function initFromURL(){
    const p=new URL(location.href).searchParams;
    const q=p.get("q"); const queue=p.get("queue"); const lang=p.get("lang"); const theme=p.get("theme");
    if(lang) { LANG=lang; localStorage.setItem(STORAGE.lang, LANG); applyLang(); }
    if(theme){ THEME=theme; localStorage.setItem(STORAGE.theme, THEME); applyBrandTheme(); }
    if(queue){ currentFilter=queue.toUpperCase(); setFilterUI(); }
    renderHistory(); if(q){ input.value=q; form?.requestSubmit(); } else setFilterUI();
  })();
  </script>
</body>
</html>
