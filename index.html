<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thunder â€” LoL Stats</title>
  <meta name="description" content="LoL stats viewer. Search summoners, matches, champions, and leaderboards.">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script>
    /* â›ï¸ ì—¬ê¸°ë¥¼ ë„ˆì˜ Worker URLë¡œ êµì²´! ì˜ˆ: https://cjsend.abcdef12345.workers.dev */
    window.API_BASE = "https://cjsend.erickparkcha.workers.dev/";
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (prefers-color-scheme: dark){ :root{ color-scheme: dark; } }
    .card{ border-radius:1rem; padding:1rem; background:#fff; border:1px solid #eee; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .dark .card{ background:#0a0a0a; border-color:#222; }
    .badge{ font-size:.75rem; padding:.25rem .5rem; border-radius:9999px; background:#f3f3f3;}
    .dark .badge{ background:#111; }
  </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-950 text-neutral-900 dark:text-neutral-100">
<header class="sticky top-0 z-10 backdrop-blur bg-white/70 dark:bg-neutral-950/70 border-b border-neutral-200/50 dark:border-neutral-800">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <div class="text-xl font-bold">Thunder</div>
    <div class="flex-1"></div>
    <button id="toggleTheme" class="text-sm px-3 py-1 rounded-full border">ğŸŒ“</button>
  </div>
  <div class="max-w-6xl mx-auto px-4 pb-3">
    <div class="flex gap-2">
      <input id="q" class="w-full px-4 py-3 rounded-2xl border" placeholder="ì†Œí™˜ì‚¬ ê²€ìƒ‰ (ì˜ˆ: Hide on bush)" />
      <button id="btnSearch" class="px-4 py-3 rounded-2xl bg-black text-white">ê²€ìƒ‰</button>
    </div>
    <div class="text-xs text-neutral-500 mt-1">KR ê¸°ë³¸, ë‹¤ë¥¸ ì§€ì—­ì€ ì¶”í›„ ì¶”ê°€</div>
  </div>
  <nav class="max-w-6xl mx-auto px-4">
    <div class="flex gap-2 pb-2">
      <button data-tab="profile" class="tab px-3 py-2 rounded-xl bg-neutral-200 dark:bg-neutral-800">í”„ë¡œí•„</button>
      <button data-tab="matches" class="tab px-3 py-2 rounded-xl">ë§¤ì¹˜</button>
      <button data-tab="champions" class="tab px-3 py-2 rounded-xl">ì±”í”¼ì–¸</button>
      <button data-tab="leaderboard" class="tab px-3 py-2 rounded-xl">ë­í‚¹</button>
    </div>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
  <!-- PROFILE -->
  <section id="panel-profile" class="space-y-3">
    <div class="card">
      <div id="profileBox" class="text-sm text-neutral-500">ì†Œí™˜ì‚¬ë¥¼ ê²€ìƒ‰í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- MATCHES -->
  <section id="panel-matches" class="hidden space-y-3">
    <div class="card">
      <div class="flex items-center justify-between">
        <div class="font-semibold">ìµœê·¼ ë§¤ì¹˜</div>
        <div class="flex gap-2 text-sm">
          <select id="filterResult" class="border rounded-lg px-2 py-1">
            <option value="all">ì „ì²´</option><option value="win">ìŠ¹</option><option value="lose">íŒ¨</option>
          </select>
          <select id="filterLane" class="border rounded-lg px-2 py-1">
            <option value="all">ëª¨ë“  í¬ì§€ì…˜</option><option>TOP</option><option>JUNGLE</option><option>MID</option><option>ADC</option><option>SUPPORT</option>
          </select>
        </div>
      </div>
      <div id="matchList" class="mt-3 space-y-3"></div>
      <button id="loadMore" class="mt-3 w-full py-2 border rounded-xl">ë” ë³´ê¸°</button>
    </div>
  </section>

  <!-- CHAMPIONS -->
  <section id="panel-champions" class="hidden space-y-3">
    <div class="card">
      <div class="font-semibold">ì±”í”¼ì–¸ ë©”íƒ€(ìš”ì•½)</div>
      <div id="champMeta" class="text-sm text-neutral-500">íŒ¨ì¹˜ ìŠ¤ëƒ…ìƒ· ì¤€ë¹„ ì¤‘â€¦</div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="panel-leaderboard" class="hidden space-y-3">
    <div class="card">
      <div class="flex items-center justify-between">
        <div class="font-semibold">KR ì±Œë¦°ì € â€” ì†”ë¡œë­í¬</div>
        <button id="refreshLb" class="text-sm px-3 py-1 rounded-xl border">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="lbTable" class="mt-3 text-sm"></div>
    </div>
  </section>
</main>

<footer class="max-w-6xl mx-auto px-4 py-10 text-xs text-neutral-500">
  Data based on Riot Games API. Not endorsed by Riot Games.
</footer>

<!-- ì•± ìŠ¤í¬ë¦½íŠ¸: DOMContentLoadedë¡œ ì•ˆì „ ì‹¤í–‰ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ì•ˆì „ì¥ì¹˜: API_BASE í™•ì¸
  if (!window.API_BASE || !/^https?:\/\//.test(window.API_BASE)) {
    alert("API_BASE ë¯¸ì„¤ì • ë˜ëŠ” í˜•ì‹ ì˜¤ë¥˜: workers.dev ì „ì²´ URLì„ ë„£ì–´ì£¼ì„¸ìš”.");
    return;
  }

  // í…Œë§ˆ í† ê¸€
  const toggleBtn = document.getElementById("toggleTheme");
  if (localStorage.getItem("theme")==="dark") document.body.classList.add("dark");
  toggleBtn?.addEventListener("click", () => {
    const d = document.body.classList.toggle("dark");
    localStorage.setItem("theme", d ? "dark" : "light");
  });

  // íƒ­
  const tabs = document.querySelectorAll(".tab");
  const panels = {
    profile: document.getElementById("panel-profile"),
    matches: document.getElementById("panel-matches"),
    champions: document.getElementById("panel-champions"),
    leaderboard: document.getElementById("panel-leaderboard"),
  };
  tabs.forEach(b=>{
    b.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("bg-neutral-200","dark:bg-neutral-800"));
      b.classList.add("bg-neutral-200","dark:bg-neutral-800");
      const tab = b.dataset.tab;
      Object.values(panels).forEach(p=>p.classList.add("hidden"));
      panels[tab]?.classList.remove("hidden");
    });
  });

  // ìƒíƒœ í‘œì‹œ ë„ìš°ë¯¸
  const profileBox = document.getElementById("profileBox");
  const setProfileLoading = ()=> profileBox.innerHTML = `<div class="animate-pulse text-neutral-400">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
  const setProfileError = (msg)=> profileBox.innerHTML = `<div class="text-red-500">${msg}</div>`;
  const renderProfile = (s)=>{
    profileBox.innerHTML = `
      <div class="flex items-center gap-3">
        <img src="https://ddragon.leagueoflegends.com/cdn/14.18.1/img/profileicon/${s.profileIconId}.png" class="w-12 h-12 rounded-xl" alt="" />
        <div>
          <div class="text-lg font-bold">${s.name}</div>
          <div class="text-sm text-neutral-500">Level ${s.summonerLevel}</div>
        </div>
      </div>`;
  };

  // ì „ì—­ ìƒíƒœ
  const q = document.getElementById("q");
  const matchList = document.getElementById("matchList");
  const loadMoreBtn = document.getElementById("loadMore");
  let CURRENT = { summoner:null, puuid:null, start:0, ids:[] };

  // ê²€ìƒ‰
  async function searchSummoner() {
    let raw = q.value.trim();
    if (!raw) return;
    const name = raw.includes("#") ? raw.split("#")[0] : raw; // name#tag â†’ nameë§Œ ì‚¬ìš©
    setProfileLoading();
    try {
      const r = await fetch(`${window.API_BASE}/api/summoner?name=${encodeURIComponent(name)}&region=kr`);
      if (!r.ok) { setProfileError("ì†Œí™˜ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      const sum = await r.json();
      CURRENT = { summoner:sum, puuid:sum.puuid, start:0, ids:[] };
      renderProfile(sum);
      await loadMatchIds(true);
    } catch (e) {
      setProfileError("ìš”ì²­ ì‹¤íŒ¨: " + (e?.message || e));
    }
  }
  document.getElementById("btnSearch")?.addEventListener("click", searchSummoner);
  q?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") searchSummoner(); });

  // ë§¤ì¹˜ ëª©ë¡
  async function loadMatchIds(reset){
    if (!CURRENT.puuid) return;
    if (reset) {
      CURRENT.start = 0; CURRENT.ids = [];
      matchList.innerHTML = "";
      panels.matches.classList.remove("hidden");
      tabs.forEach(x=>x.classList.remove("bg-neutral-200","dark:bg-neutral-800"));
      document.querySelector('[data-tab="matches"]')?.classList.add("bg-neutral-200","dark:bg-neutral-800");
    }
    try{
      const r = await fetch(`${window.API_BASE}/api/matches?puuid=${CURRENT.puuid}&start=${CURRENT.start}&count=10&region=kr`);
      if (!r.ok) return;
      const ids = await r.json();
      CURRENT.ids.push(...ids);
      CURRENT.start += 10;
      for (const id of ids) {
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = `ë§¤ì¹˜: ${id}`;
        card.addEventListener("click", () => openMatch(id, card));
        matchList.appendChild(card);
      }
    } catch(e){ /* ignore */ }
  }
  loadMoreBtn?.addEventListener("click", ()=>loadMatchIds(false));

  // ë§¤ì¹˜ ìƒì„¸
  async function openMatch(id, el){
    el.innerHTML = `<div class="animate-pulse text-neutral-400">ìƒì„¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
    try{
      const r = await fetch(`${window.API_BASE}/api/match/${id}`);
      if (!r.ok){ el.innerHTML = `<div class="text-red-500">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`; return; }
      const m = await r.json();
      const info = m.info;
      const dur = Math.round(info.gameDuration/60);
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-semibold">${info.gameMode} Â· ${dur}ë¶„</div>
          <div class="badge">${new Date(info.gameStartTimestamp).toLocaleString()}</div>
        </div>
        <div class="grid md:grid-cols-2 gap-3 mt-3">
          ${info.teams.map((t,ti)=>`
            <div class="border rounded-xl p-3">
              <div class="font-medium mb-2">íŒ€ ${ti+1} ${t.win ? 'âœ… ìŠ¹' : 'âŒ íŒ¨'}</div>
              ${info.participants.filter(p=>p.teamId===t.teamId).map(p=>{
                const kda = p.deaths===0 ? \`\${p.kills}/0/\${p.assists}\` : \`\${p.kills}/\${p.deaths}/\${p.assists}\`;
                return `
                  <div class="flex items-center gap-2 py-1 text-sm">
                    <img class="w-8 h-8 rounded" src="https://ddragon.leagueoflegends.com/cdn/14.18.1/img/champion/${p.championName}.png" alt="">
                    <div class="flex-1 truncate">${p.summonerName}</div>
                    <div class="tabular-nums">${kda}</div>
                    <div class="tabular-nums w-16 text-right">${p.totalDamageDealtToChampions}</div>
                  </div>`;
              }).join("")}
            </div>
          `).join("")}
        </div>`;
    }catch(e){ el.innerHTML = `<div class="text-red-500">ì˜¤ë¥˜: ${e?.message || e}</div>`; }
  }

  // ë¦¬ë”ë³´ë“œ
  async function loadLeaderboard(){
    try{
      const r = await fetch(`${window.API_BASE}/api/leaderboard?queue=RANKED_SOLO_5x5&region=kr`);
      if (!r.ok) return;
      const d = await r.json();
      const rows = (d.entries || []).slice(0, 100).sort((a,b)=>b.leaguePoints-a.leaguePoints);
      document.getElementById("lbTable").innerHTML = `
        <div class="grid grid-cols-5 gap-2">
          <div class="font-semibold">#</div><div class="font-semibold">ì†Œí™˜ì‚¬</div>
          <div class="font-semibold">LP</div><div class="font-semibold">ìŠ¹</div><div class="font-semibold">íŒ¨</div>
          ${rows.map((e,i)=>`
            <div>${i+1}</div><div class="truncate">${e.summonerName}</div>
            <div>${e.leaguePoints}</div><div>${e.wins}</div><div>${e.losses}</div>
          `).join("")}
        </div>`;
    }catch(e){ /* ignore */ }
  }
  document.getElementById("refreshLb")?.addEventListener("click", loadLeaderboard);

  // ì´ˆê¸° ë¡œë“œ
  loadLeaderboard();
});
</script>
</body>
</html>
