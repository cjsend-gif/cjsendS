<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thunder — LoL Stats</title>
  <meta name="description" content="LoL stats viewer. Search summoners, matches, champions, and leaderboards.">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script>
    /* ⛏️ 여기를 너의 Worker URL로 교체! 예: https://cjsend.abcdef12345.workers.dev */
    window.API_BASE = "https://cjsend.erickparkcha.workers.dev/";
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (prefers-color-scheme: dark){ :root{ color-scheme: dark; } }
    .card{ border-radius:1rem; padding:1rem; background:#fff; border:1px solid #eee; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .dark .card{ background:#0a0a0a; border-color:#222; }
    .badge{ font-size:.75rem; padding:.25rem .5rem; border-radius:9999px; background:#f3f3f3;}
    .dark .badge{ background:#111; }
  </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-950 text-neutral-900 dark:text-neutral-100">
<header class="sticky top-0 z-10 backdrop-blur bg-white/70 dark:bg-neutral-950/70 border-b border-neutral-200/50 dark:border-neutral-800">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <div class="text-xl font-bold">Thunder</div>
    <div class="flex-1"></div>
    <button id="toggleTheme" class="text-sm px-3 py-1 rounded-full border">🌓</button>
  </div>
  <div class="max-w-6xl mx-auto px-4 pb-3">
    <div class="flex gap-2">
      <input id="q" class="w-full px-4 py-3 rounded-2xl border" placeholder="소환사 검색 (예: Hide on bush)" />
      <button id="btnSearch" class="px-4 py-3 rounded-2xl bg-black text-white">검색</button>
    </div>
    <div class="text-xs text-neutral-500 mt-1">KR 기본, 다른 지역은 추후 추가</div>
  </div>
  <nav class="max-w-6xl mx-auto px-4">
    <div class="flex gap-2 pb-2">
      <button data-tab="profile" class="tab px-3 py-2 rounded-xl bg-neutral-200 dark:bg-neutral-800">프로필</button>
      <button data-tab="matches" class="tab px-3 py-2 rounded-xl">매치</button>
      <button data-tab="champions" class="tab px-3 py-2 rounded-xl">챔피언</button>
      <button data-tab="leaderboard" class="tab px-3 py-2 rounded-xl">랭킹</button>
    </div>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
  <!-- PROFILE -->
  <section id="panel-profile" class="space-y-3">
    <div class="card">
      <div id="profileBox" class="text-sm text-neutral-500">소환사를 검색하면 요약이 표시됩니다.</div>
    </div>
  </section>

  <!-- MATCHES -->
  <section id="panel-matches" class="hidden space-y-3">
    <div class="card">
      <div class="flex items-center justify-between">
        <div class="font-semibold">최근 매치</div>
        <div class="flex gap-2 text-sm">
          <select id="filterResult" class="border rounded-lg px-2 py-1">
            <option value="all">전체</option><option value="win">승</option><option value="lose">패</option>
          </select>
          <select id="filterLane" class="border rounded-lg px-2 py-1">
            <option value="all">모든 포지션</option><option>TOP</option><option>JUNGLE</option><option>MID</option><option>ADC</option><option>SUPPORT</option>
          </select>
        </div>
      </div>
      <div id="matchList" class="mt-3 space-y-3"></div>
      <button id="loadMore" class="mt-3 w-full py-2 border rounded-xl">더 보기</button>
    </div>
  </section>

  <!-- CHAMPIONS -->
  <section id="panel-champions" class="hidden space-y-3">
    <div class="card">
      <div class="font-semibold">챔피언 메타(요약)</div>
      <div id="champMeta" class="text-sm text-neutral-500">패치 스냅샷 준비 중…</div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="panel-leaderboard" class="hidden space-y-3">
    <div class="card">
      <div class="flex items-center justify-between">
        <div class="font-semibold">KR 챌린저 — 솔로랭크</div>
        <button id="refreshLb" class="text-sm px-3 py-1 rounded-xl border">새로고침</button>
      </div>
      <div id="lbTable" class="mt-3 text-sm"></div>
    </div>
  </section>
</main>

<footer class="max-w-6xl mx-auto px-4 py-10 text-xs text-neutral-500">
  Data based on Riot Games API. Not endorsed by Riot Games.
</footer>

<!-- 앱 스크립트: DOMContentLoaded로 안전 실행 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 안전장치: API_BASE 확인
  if (!window.API_BASE || !/^https?:\/\//.test(window.API_BASE)) {
    alert("API_BASE 미설정 또는 형식 오류: workers.dev 전체 URL을 넣어주세요.");
    return;
  }

  // 테마 토글
  const toggleBtn = document.getElementById("toggleTheme");
  if (localStorage.getItem("theme")==="dark") document.body.classList.add("dark");
  toggleBtn?.addEventListener("click", () => {
    const d = document.body.classList.toggle("dark");
    localStorage.setItem("theme", d ? "dark" : "light");
  });

  // 탭
  const tabs = document.querySelectorAll(".tab");
  const panels = {
    profile: document.getElementById("panel-profile"),
    matches: document.getElementById("panel-matches"),
    champions: document.getElementById("panel-champions"),
    leaderboard: document.getElementById("panel-leaderboard"),
  };
  tabs.forEach(b=>{
    b.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("bg-neutral-200","dark:bg-neutral-800"));
      b.classList.add("bg-neutral-200","dark:bg-neutral-800");
      const tab = b.dataset.tab;
      Object.values(panels).forEach(p=>p.classList.add("hidden"));
      panels[tab]?.classList.remove("hidden");
    });
  });

  // 상태 표시 도우미
  const profileBox = document.getElementById("profileBox");
  const setProfileLoading = ()=> profileBox.innerHTML = `<div class="animate-pulse text-neutral-400">불러오는 중…</div>`;
  const setProfileError = (msg)=> profileBox.innerHTML = `<div class="text-red-500">${msg}</div>`;
  const renderProfile = (s)=>{
    profileBox.innerHTML = `
      <div class="flex items-center gap-3">
        <img src="https://ddragon.leagueoflegends.com/cdn/14.18.1/img/profileicon/${s.profileIconId}.png" class="w-12 h-12 rounded-xl" alt="" />
        <div>
          <div class="text-lg font-bold">${s.name}</div>
          <div class="text-sm text-neutral-500">Level ${s.summonerLevel}</div>
        </div>
      </div>`;
  };

  // 전역 상태
  const q = document.getElementById("q");
  const matchList = document.getElementById("matchList");
  const loadMoreBtn = document.getElementById("loadMore");
  let CURRENT = { summoner:null, puuid:null, start:0, ids:[] };

  // 검색
  async function searchSummoner() {
    let raw = q.value.trim();
    if (!raw) return;
    const name = raw.includes("#") ? raw.split("#")[0] : raw; // name#tag → name만 사용
    setProfileLoading();
    try {
      const r = await fetch(`${window.API_BASE}/api/summoner?name=${encodeURIComponent(name)}&region=kr`);
      if (!r.ok) { setProfileError("소환사를 찾을 수 없습니다."); return; }
      const sum = await r.json();
      CURRENT = { summoner:sum, puuid:sum.puuid, start:0, ids:[] };
      renderProfile(sum);
      await loadMatchIds(true);
    } catch (e) {
      setProfileError("요청 실패: " + (e?.message || e));
    }
  }
  document.getElementById("btnSearch")?.addEventListener("click", searchSummoner);
  q?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") searchSummoner(); });

  // 매치 목록
  async function loadMatchIds(reset){
    if (!CURRENT.puuid) return;
    if (reset) {
      CURRENT.start = 0; CURRENT.ids = [];
      matchList.innerHTML = "";
      panels.matches.classList.remove("hidden");
      tabs.forEach(x=>x.classList.remove("bg-neutral-200","dark:bg-neutral-800"));
      document.querySelector('[data-tab="matches"]')?.classList.add("bg-neutral-200","dark:bg-neutral-800");
    }
    try{
      const r = await fetch(`${window.API_BASE}/api/matches?puuid=${CURRENT.puuid}&start=${CURRENT.start}&count=10&region=kr`);
      if (!r.ok) return;
      const ids = await r.json();
      CURRENT.ids.push(...ids);
      CURRENT.start += 10;
      for (const id of ids) {
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = `매치: ${id}`;
        card.addEventListener("click", () => openMatch(id, card));
        matchList.appendChild(card);
      }
    } catch(e){ /* ignore */ }
  }
  loadMoreBtn?.addEventListener("click", ()=>loadMatchIds(false));

  // 매치 상세
  async function openMatch(id, el){
    el.innerHTML = `<div class="animate-pulse text-neutral-400">상세 불러오는 중…</div>`;
    try{
      const r = await fetch(`${window.API_BASE}/api/match/${id}`);
      if (!r.ok){ el.innerHTML = `<div class="text-red-500">불러오기 실패</div>`; return; }
      const m = await r.json();
      const info = m.info;
      const dur = Math.round(info.gameDuration/60);
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-semibold">${info.gameMode} · ${dur}분</div>
          <div class="badge">${new Date(info.gameStartTimestamp).toLocaleString()}</div>
        </div>
        <div class="grid md:grid-cols-2 gap-3 mt-3">
          ${info.teams.map((t,ti)=>`
            <div class="border rounded-xl p-3">
              <div class="font-medium mb-2">팀 ${ti+1} ${t.win ? '✅ 승' : '❌ 패'}</div>
              ${info.participants.filter(p=>p.teamId===t.teamId).map(p=>{
                const kda = p.deaths===0 ? \`\${p.kills}/0/\${p.assists}\` : \`\${p.kills}/\${p.deaths}/\${p.assists}\`;
                return `
                  <div class="flex items-center gap-2 py-1 text-sm">
                    <img class="w-8 h-8 rounded" src="https://ddragon.leagueoflegends.com/cdn/14.18.1/img/champion/${p.championName}.png" alt="">
                    <div class="flex-1 truncate">${p.summonerName}</div>
                    <div class="tabular-nums">${kda}</div>
                    <div class="tabular-nums w-16 text-right">${p.totalDamageDealtToChampions}</div>
                  </div>`;
              }).join("")}
            </div>
          `).join("")}
        </div>`;
    }catch(e){ el.innerHTML = `<div class="text-red-500">오류: ${e?.message || e}</div>`; }
  }

  // 리더보드
  async function loadLeaderboard(){
    try{
      const r = await fetch(`${window.API_BASE}/api/leaderboard?queue=RANKED_SOLO_5x5&region=kr`);
      if (!r.ok) return;
      const d = await r.json();
      const rows = (d.entries || []).slice(0, 100).sort((a,b)=>b.leaguePoints-a.leaguePoints);
      document.getElementById("lbTable").innerHTML = `
        <div class="grid grid-cols-5 gap-2">
          <div class="font-semibold">#</div><div class="font-semibold">소환사</div>
          <div class="font-semibold">LP</div><div class="font-semibold">승</div><div class="font-semibold">패</div>
          ${rows.map((e,i)=>`
            <div>${i+1}</div><div class="truncate">${e.summonerName}</div>
            <div>${e.leaguePoints}</div><div>${e.wins}</div><div>${e.losses}</div>
          `).join("")}
        </div>`;
    }catch(e){ /* ignore */ }
  }
  document.getElementById("refreshLb")?.addEventListener("click", loadLeaderboard);

  // 초기 로드
  loadLeaderboard();
});
</script>
</body>
</html>
