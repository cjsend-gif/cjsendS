<!doctype html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thunder · 전적검색</title>

  <!-- Tailwind (CDN) -->
  <script>
    window.tailwind = {
      config: {
        theme: {
          container: { center: true, padding: "1rem" },
          extend: {
            fontFamily: { sans: ["Inter","Pretendard","Noto Sans KR","system-ui","-apple-system","Segoe UI","sans-serif"] },
            colors: {
              ink: { DEFAULT:"#0b1220" },
              panel: "#0d1324",
              line: "#20283a",
              muted: "#9aa3b2",
              accent: { 500:"#60a5fa", 600:"#3b82f6" }
            },
            boxShadow: { soft: "0 10px 30px rgba(0,0,0,.18)" },
            borderRadius: { xl: "16px", "2xl":"20px" }
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + plugins (Chart.js v4 호환 경로 고정) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.4.0/dist/chartjs-chart-boxplot.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.umd.min.js"></script>

  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{ --bg:#0b1220; --panel:#0d1324; --line:#20283a; --ink:#e5e7eb; --muted:#9aa3b2; --accent:#60a5fa; }
    @media (prefers-color-scheme: light) {
      :root{ --bg:#f6f8fb; --panel:#ffffff; --line:#e5e7eb; --ink:#0b1220; --muted:#6b7280; --accent:#3b82f6; }
      .dark-only{ display:none!important }
    }
    @media (prefers-color-scheme: dark){ .light-only{ display:none!important } }
    html,body{height:100%}
    body{ background:var(--bg); color:var(--ink); font-size:16.5px; line-height:1.65 }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; box-shadow:0 12px 36px rgba(0,0,0,.22) }
    .btn{ display:inline-flex; align-items:center; justify-content:center; height:44px; padding:0 16px; border-radius:12px; font-weight:600 }
    .btn-primary{ background:var(--accent); color:#081018 }
    .chip{ padding:8px 12px; border:1px solid var(--line); border-radius:9999px; background:transparent; cursor:pointer }
    .chip.is-active{ outline:3px solid rgba(96,165,250,.35); border-color:var(--accent) }
    .muted{ color:var(--muted) }
    .knum{ font-feature-settings: "tnum"; font-variant-numeric: tabular-nums }
    table.simple{ width:100%; border-collapse:collapse; font-size:.95rem }
    table.simple th, table.simple td{ border:1px solid var(--line); padding:.5rem .6rem; text-align:left }
    table.simple th{ background:rgba(229,231,235,.06); font-weight:600 }
    /* 우하단 에러 배지 */
    #js-test{ position:fixed; right:10px; bottom:10px; padding:6px 10px; border:1px solid #9aa3b2; border-radius:10px; background:#111; color:#fff; font:12px/1.2 ui-monospace,Menlo,Consolas,monospace; z-index:9999 }
    @media (prefers-color-scheme: light){ #js-test{ background:#fff; color:#111 } }
    /* 최근검색 드롭다운 */
    #recent-box{ max-height:220px; overflow:auto }
  </style>
</head>

<body class="font-sans">
  <!-- ===== 에러 배지 ===== -->
  <div id="js-test">JS: ON</div>
  <script>
    (function(){
      var el = document.getElementById('js-test');
      function set(msg){ if(el) el.textContent = msg; }
      window.addEventListener('error', function(e){
        var loc = (e && e.filename ? e.filename : 'index.html')
                + (e && e.lineno ? (':' + e.lineno) : '')
                + (e && e.colno ? (':' + e.colno) : '');
        set('ERR ' + loc + ' — ' + (e && e.message ? e.message : 'error'));
      });
      window.addEventListener('unhandledrejection', function(e){
        var r = e && e.reason;
        var msg = (r && r.stack) ? r.stack.split('\n')[0] : (r && r.message ? r.message : r);
        set('REJ ' + msg);
      });
      setTimeout(function(){ if(el && el.textContent.indexOf('JS: ON')===0) el.style.display='none'; }, 10000);
    })();
  </script>

  <!-- ===== 상단 헤더 ===== -->
  <header class="sticky top-0 z-40 border-b" style="border-color:var(--line); backdrop-filter:saturate(1.2) blur(6px); background:rgba(11,18,32,.8)">
    <div class="container max-w-5xl py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-xl font-extrabold tracking-tight"><span>⚡</span><span>Thunder</span></div>
      <details id="menu" class="relative">
        <summary class="btn chip select-none">⋯ <span class="sr-only">메뉴</span></summary>
        <div class="absolute right-0 mt-2 min-w-60 card p-2 text-sm">
          <button id="btn-lang" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">🌐 언어 <span id="lang-code" class="ml-1 px-2 py-0.5 rounded bg-black/10">KO</span></button>
          <button id="btn-chart-theme" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">🌓 차트 테마 <span id="chart-theme-code" class="ml-1 px-2 py-0.5 rounded bg-black/10">AUTO</span></button>
          <hr class="my-2 border-t" style="border-color:var(--line)">
          <button id="btn-export" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">📄 CSV 내보내기</button>
          <button id="btn-save-charts" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">📷 차트 저장(PNG)</button>
          <button id="btn-share" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">🔗 링크 복사</button>
          <hr class="my-2 border-t" style="border-color:var(--line)">
          <button id="btn-clear-cache" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">🧹 로컬설정 초기화</button>
        </div>
      </details>
    </div>
  </header>

  <!-- ===== 본문 ===== -->
  <main class="container max-w-5xl py-6 space-y-6">
    <section class="card p-4 md:p-5">
      <form id="search-form" class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3" role="search" autocomplete="off">
        <div class="relative">
          <label class="sr-only" for="summoner-name">소환사명 또는 Riot ID</label>
          <input id="summoner-name" class="w-full h-12 px-4 rounded-xl border outline-none" style="border-color:var(--line); background:transparent" placeholder="예) Hide on bush#KR1" />
          <!-- 최근검색 -->
          <details id="recent" class="absolute left-0 right-0 top-[46px]">
            <summary class="sr-only">최근검색</summary>
            <div id="recent-box" class="card p-2 text-sm"></div>
          </details>
        </div>
        <button type="submit" class="btn btn-primary">검색</button>
      </form>
      <p class="muted text-sm mt-2">최근 5판 기준 간단 요약을 보여줍니다. · <span id="net-state">네트워크: 확인 중…</span></p>
    </section>

    <section class="card p-3 md:p-4">
      <div id="filter-bar" class="flex flex-wrap gap-2">
        <button class="chip is-active" data-filter="ALL">전체</button>
        <button class="chip" data-filter="RANKED_SOLO_5x5">솔로랭크</button>
        <button class="chip" data-filter="RANKED_FLEX_SR">자유랭크</button>
        <button class="chip" data-filter="NORMAL">일반</button>
        <button class="chip" data-filter="ARAM">ARAM</button>
      </div>
    </section>

    <section id="strip" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="card p-4"><div class="muted text-sm">최근 승률</div><div id="kpi-winrate" class="text-3xl font-extrabold knum">–</div></div>
      <div class="card p-4"><div class="muted text-sm">평균 KDA</div><div id="kpi-kda" class="text-3xl font-extrabold knum">–</div></div>
      <div class="card p-4"><div class="muted text-sm">주 포지션</div><div id="kpi-role" class="text-3xl font-extrabold">–</div></div>
    </section>

    <section id="result" class="card p-5" aria-live="polite">
      <div class="muted">위 입력창에 소환사명을 입력해 주세요.</div>
    </section>

    <details id="advanced" class="card p-4" open>
      <summary class="cursor-pointer font-semibold">고급 통계</summary>
      <div class="mt-4 space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">승률</div><canvas id="chart-winrate" height="160"></canvas></div>
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">포지션 분포</div><canvas id="chart-roles" height="160"></canvas></div>
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">승률 추이</div><canvas id="chart-trend" height="160"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-3 rounded-xl border" style="border-color:var(--line)">
            <div class="flex items-center justify-between">
              <div class="muted mb-2">챔피언 성과 Top N</div>
              <label class="muted text-xs flex items-center gap-1">N
                <input id="topN" type="number" min="3" max="15" value="7" class="w-16 h-8 px-2 rounded border" style="border-color:var(--line); background:transparent">
              </label>
            </div>
            <canvas id="chart-champs" height="200"></canvas>
          </div>
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">KDA 분포(박스플롯)</div><canvas id="chart-kda" height="200"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">라인별 승률 추이</div><canvas id="chart-role-trend" height="200"></canvas></div>
          <div class="p-3 rounded-xl border" style="border-color:var(--line)">
            <div class="flex items-center justify-between">
              <div class="muted mb-2">챔피언 KDA 히트맵</div>
              <label class="muted text-xs flex items-center gap-2">축
                <select id="heat-axes" class="h-8 px-2 rounded border" style="border-color:var(--line); background:transparent">
                  <option value="champ-queue">Champion × Queue</option>
                  <option value="queue-champ">Queue × Champion</option>
                </select>
              </label>
            </div>
            <canvas id="chart-heatmap" height="200"></canvas>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">시간대별 승률(현지)</div><canvas id="chart-hourly" height="200"></canvas></div>
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">아이템 빌드 빈도(Top 12)</div><div id="items-cloud" class="flex flex-wrap gap-2"></div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-3 rounded-xl border" style="border-color:var(--line)">
            <div class="muted mb-2">라인별 KDA 평균</div>
            <table id="role-kda-table" class="simple">
              <thead><tr><th>라인</th><th>평균 KDA</th><th>게임 수</th></tr></thead><tbody></tbody>
            </table>
          </div>
          <div class="p-3 rounded-xl border" style="border-color:var(--line)"><div class="muted mb-2">아이템 빌드 클러스터</div><div id="items-clusters" class="flex flex-col gap-2"></div></div>
        </div>
      </div>
    </details>

    <!-- 비교 모드 -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold">👥 비교 모드</div>
        <button id="btn-compare-run" class="chip">비교 실행</button>
      </div>
      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
        <input id="summoner-a" class="h-10 px-3 rounded border" style="border-color:var(--line); background:transparent" placeholder="A: 예) Faker#KR1">
        <input id="summoner-b" class="h-10 px-3 rounded border" style="border-color:var(--line); background:transparent" placeholder="B: 예) Deft#KR1">
      </div>
      <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><canvas id="chart-compare" height="160"></canvas></div>
        <div><canvas id="chart-compare-role" height="160"></canvas></div>
      </div>
      <div id="compare-summary" class="mt-2 text-sm muted"></div>
    </section>

    <section class="grid md:grid-cols-2 gap-3">
      <button id="btn-more" class="card btn w-full h-12" disabled>더 보기 (+5)</button>
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <span class="muted text-sm">/health</span>
          <button id="btn-health" class="chip">체크</button>
        </div>
        <div id="health-state" class="mt-2 text-sm muted"></div>
      </div>
    </section>

    <footer class="text-sm muted pt-2 pb-10">
      Front: GitHub Pages · Back: <code>https://cjsend.erickparkcha.workers.dev</code>
    </footer>
  </main>

  <!-- ===== App (ES5-safe) ===== -->
  <script>
  /* helpers */
  function qs(s, r){ return (r||document).querySelector(s); }
  function qsa(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
  function safe(v){ v = (v===null || v===undefined) ? "" : String(v); return v.replace(/[&<>]/g, function(s){ return ({ "&":"&amp;","<":"&lt;",">":"&gt;" })[s]; }); }
  function fmtT(sec){ if(!sec) return "-:--"; var m=Math.floor(sec/60), s=('0'+Math.floor(sec%60)).slice(-2); return m+":"+s; }
  function timeAgo(ms){ var t=Date.now()-(ms||0), m=Math.floor(t/60000); if(m<1) return "방금 전"; if(m<60) return m+"분 전"; var h=Math.floor(m/60); if(h<24) return h+"시간 전"; var d=Math.floor(h/24); return d+"일 전"; }

  /* config */
  var API_BASE = "https://cjsend.erickparkcha.workers.dev";
  var STORAGE = { hist:"th_recent", lang:"th_lang", chartTheme:"th_chart_theme", heatAxes:"th_heat_axes" };
  var DDRAGON_VER = "latest";
  try { fetch("https://ddragon.leagueoflegends.com/api/versions.json").then(function(r){return r.json();}).then(function(j){ if(j&&j.length) DDRAGON_VER=j[0]; }); } catch(e){}

  /* i18n */
  var i18n = { ko:{ searchBtn:"검색", empty:"위 입력창에 소환사명을 입력해 주세요.", errTitle:"에러", errLoad:"프로필을 불러오지 못했습니다.", cached:"최대 45초 캐시됨", recent:"최근검색", none:"데이터 없음" },
               en:{ searchBtn:"Search", empty:"Enter a Summoner name or Riot ID above.", errTitle:"Error", errLoad:"Failed to load profile.", cached:"Cached up to 45s", recent:"Recent", none:"No data" } };
  var LANG = localStorage.getItem(STORAGE.lang) || "ko";
  function T(k){ return (i18n[LANG] && i18n[LANG][k]) || i18n.ko[k] || k; }

  /* chart theme */
  var CHART_THEME = localStorage.getItem(STORAGE.chartTheme) || "auto";
  var mediaDark = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;
  function isDark(){ return CHART_THEME==="dark" || (CHART_THEME==="auto" && mediaDark && mediaDark.matches); }
  function chartColors(){ var dark=isDark(); return { text: dark?"#e5e7eb":"#111827", grid: dark?"rgba(255,255,255,.15)":"rgba(17,24,39,.15)", heat: function(v){ return dark ? "rgba(255,255,255,"+Math.min(0.15+v/10*0.85,1)+")" : "rgba(0,0,0,"+Math.min(0.08+v/12*0.75,0.9)+")"; } }; }
  function applyChartDefaults(){ var c=chartColors(); if(window.Chart && Chart.defaults){ Chart.defaults.color=c.text; Chart.defaults.borderColor=c.grid; } }
  applyChartDefaults();
  if(mediaDark){
    if(mediaDark.addEventListener){ mediaDark.addEventListener("change", function(){ if(CHART_THEME==="auto" && window._accum){ applyChartDefaults(); renderCharts(window._accum); } }); }
    else if(mediaDark.addListener){ mediaDark.addListener(function(){ if(CHART_THEME==="auto" && window._accum){ applyChartDefaults(); renderCharts(window._accum); } }); }
  }
  qs("#chart-theme-code").textContent = CHART_THEME.toUpperCase();

  /* DOM */
  var form=qs("#search-form"), input=qs("#summoner-name"), out=qs("#result");
  var stripWin=qs("#kpi-winrate"), stripKDA=qs("#kpi-kda"), stripRole=qs("#kpi-role");
  var filterBar=qs("#filter-bar"), moreBtn=qs("#btn-more"), healthBtn=qs("#btn-health"), healthState=qs("#health-state");
  var topNEl=qs("#topN"), heatAxesSel=qs("#heat-axes");
  var chartThemeBtn=qs("#btn-chart-theme"), langBtn=qs("#btn-lang");
  var netState=qs("#net-state"), recentBox=qs("#recent-box"), recentToggle=qs("#recent");
  qs("#lang-code").textContent = (LANG||"ko").toUpperCase();

  /* state */
  var currentFilter="ALL", currentName="", loadedCount=0;
  heatAxesSel.value = localStorage.getItem(STORAGE.heatAxes) || "champ-queue";
  var RECENTS = [];
  try { RECENTS = JSON.parse(localStorage.getItem(STORAGE.hist)||"[]") || []; } catch(e){ RECENTS=[]; }

  /* network quick check */
  function checkHealth(){
    var t0=Date.now();
    return fetch(API_BASE+"/health", {cache:"no-store"}).then(function(r){ return r.text().then(function(txt){ return {ok:r.ok, status:r.status, txt:txt, ms:Date.now()-t0}; }); })
      .then(function(p){ netState.textContent=p.ok?("OK "+p.ms+"ms"):("ERR "+p.status); return p.ok; })
      .catch(function(e){ netState.textContent="오프라인"; return false; });
  }
  checkHealth();

  /* API */
  function fetchProfile(name, count, queue, start){
    count = (typeof count==="number") ? count : 5;
    queue = queue || "ALL";
    start = (typeof start==="number") ? start : 0;
    var url = API_BASE + "/profile?name=" + encodeURIComponent(name) + "&count=" + count + "&queue=" + encodeURIComponent(queue) + "&start=" + start;
    return fetch(url).then(function(res){ return res.json().then(function(json){ return { ok:res.ok, json:json, status:res.status }; }); })
      .then(function(p){ if(!p.ok || p.json.error){ var err = (typeof p.json.error==="string")?p.json.error:JSON.stringify(p.json.error||{}); throw new Error(err || ("HTTP "+p.status)); } return p.json; });
  }

  /* items meta */
  var ITEM_DICT=null;
  function itemIconURL(id){ return "https://ddragon.leagueoflegends.com/cdn/"+DDRAGON_VER+"/img/item/"+id+".png"; }
  function ensureItemDict(){
    if(ITEM_DICT) return Promise.resolve(ITEM_DICT);
    var locale = (LANG==="en") ? "en_US" : "ko_KR";
    return fetch("https://ddragon.leagueoflegends.com/cdn/"+DDRAGON_VER+"/data/"+locale+"/item.json")
      .then(function(r){ return r.json(); }).then(function(j){ ITEM_DICT=(j&&j.data)||{}; return ITEM_DICT; }).catch(function(){ ITEM_DICT={}; return ITEM_DICT; });
  }

  /* helpers ui */
  function setChips(){ qsa("#filter-bar .chip").forEach(function(b){ b.classList.toggle("is-active", b.getAttribute("data-filter")===currentFilter); }); }
  function rankLine(e){ if(!e) return '<span class="muted">언랭크</span>'; var lp=(typeof e.leaguePoints==="number")?(e.leaguePoints+"LP"):""; var wr=(e.wins+e.losses>0)?(" · "+Math.round(e.wins/(e.wins+e.losses)*100)+"%"):""; var tier=String(e.tier||"").toLowerCase().replace(/^\w/,function(c){return c.toUpperCase();}); return "<b>"+tier+" "+(e.rank||"")+"</b> "+lp+wr; }

  /* charts holders */
  var chartWin=null, chartRoles=null, chartTrend=null, chartChamps=null, chartKDA=null, chartRoleTrend=null, chartHeatmap=null, chartHourly=null, chartCmp=null, chartCmpRole=null;

  function renderError(msg, debug){
    out.innerHTML = '<div class="p-4 rounded-xl" style="background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.35)"><div class="font-semibold">'+T("errTitle")+'</div><div class="mt-1">'+safe(msg)+'</div>'+(debug?'<pre class="mt-2 text-xs opacity-80 whitespace-pre-wrap">'+safe(debug)+'</pre>':'')+'</div>';
    moreBtn.disabled=true;
  }
  function renderLoading(){ out.innerHTML = '<div class="p-4 muted">Loading…</div>'; }

  function renderKPIs(items){
    var wins=items.filter(function(m){return m.win;}).length, tot=items.length;
    stripWin.textContent = tot ? Math.round(wins/tot*100)+'%' : '–';
    var kd = items.map(function(m){ var mch=(m.kda||'').match(/^(\d+)\/(\d+)\/(\d+)/)||[]; var k=+mch[1]||0, d=+mch[2]||0, a=+mch[3]||0; return d===0?(k+a):(k+a)/d; });
    stripKDA.textContent = kd.length ? (kd.reduce(function(s,v){return s+v;},0)/kd.length).toFixed(2) : '–';
    var roleCnt = items.reduce(function(mm,x){ var r=(x.role||'').toUpperCase(); if(!r) return mm; mm[r]=(mm[r]||0)+1; return mm; }, {});
    var topRole = Object.keys(roleCnt).sort(function(a,b){return roleCnt[b]-roleCnt[a];})[0] || '–';
    stripRole.textContent = topRole;
  }

  function renderItemsCloud(items){
    return ensureItemDict().then(function(dict){
      var target=qs("#items-cloud"); var freq={};
      items.forEach(function(m){ (m.items||[]).forEach(function(id){ if(id) freq[id]=(freq[id]||0)+1; }); });
      var top=Object.keys(freq).map(function(id){return [id,freq[id]];}).sort(function(a,b){return b[1]-a[1];}).slice(0,12);
      target.innerHTML = top.length ? top.map(function(p){
        var id=p[0], c=p[1]; var name=(dict[id]&&dict[id].name)||id;
        return '<div class="chip flex items-center gap-2" title="'+safe(name)+' ×'+c+'"><img src="'+itemIconURL(id)+'" class="w-6 h-6 rounded" alt="'+safe(name)+'"><span class="text-sm">'+safe(String(name).slice(0,12))+'</span><span class="muted text-xs">×'+c+'</span></div>';
      }).join("") : '<div class="muted text-sm">'+T("none")+'</div>';
    });
  }

  /* 간단한 빌드 클러스터 */
  function clusterBuilds(items){
    function uniqSorted(arr){ var s={}, out=[]; arr.forEach(function(x){ if(x) s[x]=1; }); Object.keys(s).sort(function(a,b){return a-b;}).forEach(function(k){ out.push(+k); }); return out; }
    var builds = items.map(function(m){ return uniqSorted(m.items||[]); }).filter(function(a){ return a.length; });
    var clusters=[];
    function sim(a,b){ var A={},B={},i, inter=0, uni; for(i=0;i<a.length;i++) A[a[i]]=1; for(i=0;i<b.length;i++) B[b[i]]=1; Object.keys(A).forEach(function(x){ if(B[x]) inter++; }); uni=Object.keys(A).length+Object.keys(B).length-inter; return uni? inter/uni:0; }
    builds.forEach(function(b){
      var placed=false, i;
      for(i=0;i<clusters.length;i++){
        var c=clusters[i];
        if(sim(c.rep,b)>=0.5){
          c.items.push(b);
          var f={}, j, k;
          for(j=0;j<c.items.length;j++){ for(k=0;k<c.items[j].length;k++){ var id=c.items[j][k]; f[id]=(f[id]||0)+1; } }
          c.rep=Object.keys(f).sort(function(x,y){return f[y]-f[x];}).map(function(id){return +id;}).slice(0,6);
          placed=true; break;
        }
      }
      if(!placed){ clusters.push({rep:b.slice(), items:[b]}); }
    });
    return clusters.sort(function(a,b){ return b.items.length-a.items.length; });
  }
  function renderItemClusters(items){
    return ensureItemDict().then(function(dict){
      var wrap=qs("#items-clusters");
      var cls=clusterBuilds(items).slice(0,5);
      wrap.innerHTML = cls.length ? cls.map(function(c,idx){
        var rep=c.rep.map(function(id){ var nm=(dict[id]&&dict[id].name)||id; return '<div class="flex items-center gap-1" title="'+safe(nm)+'"><img src="'+itemIconURL(id)+'" class="w-6 h-6 rounded"><span class="text-xs">'+safe(String(nm).slice(0,10))+'</span></div>'; }).join("");
        return '<div class="p-2 rounded-xl border" style="border-color:var(--line)"><div class="muted text-xs mb-1">Cluster '+(idx+1)+' · '+c.items.length+' games</div><div class="flex flex-wrap gap-2">'+rep+'</div></div>';
      }).join("") : '<div class="muted text-sm">'+T("none")+'</div>';
    });
  }

  function renderRoleKDATable(items){
    var roles = ["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"], tbody=qs("#role-kda-table tbody");
    var rows = roles.map(function(r){
      var arr=items.filter(function(m){ return (m.role||"").toUpperCase()===r; });
      var kd=arr.map(function(m){ var mch=(m.kda||'').match(/^(\d+)\/(\d+)\/(\d+)/)||[]; var k=+mch[1]||0, d=+mch[2]||0, a=+mch[3]||0; return d===0?(k+a):(k+a)/d; });
      var avg = kd.length ? (kd.reduce(function(s,v){return s+v;},0)/kd.length).toFixed(2) : "-";
      return '<tr><td>'+r+'</td><td>'+avg+'</td><td>'+arr.length+'</td></tr>';
    }).join("");
    tbody.innerHTML = rows;
  }

  function renderCharts(items){
    var C=chartColors();

    var wins=items.filter(function(m){return m.win;}).length, losses=items.length-wins;
    if(chartWin) chartWin.destroy();
    chartWin=new Chart(qs("#chart-winrate"), { type:"doughnut", data:{ labels:["승","패"], datasets:[{ data:[wins,losses] }] }, options:{ plugins:{legend:{ labels:{ color:C.text }}}}});

    var roles=["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"], counts=roles.map(function(r){ return items.filter(function(x){return (x.role||"").toUpperCase()===r;}).length; });
    if(chartRoles) chartRoles.destroy();
    chartRoles=new Chart(qs("#chart-roles"),{ type:"bar", data:{ labels:roles, datasets:[{ data:counts }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});

    var sorted=items.slice().sort(function(a,b){ return (a.timestamp||0)-(b.timestamp||0); }), cum=0;
    var lab=sorted.map(function(m){ return new Date(m.timestamp||0).toLocaleDateString(); });
    var dat=sorted.map(function(m,i){ if(m.win) cum++; return Math.round(cum/(i+1)*100); });
    if(chartTrend) chartTrend.destroy();
    chartTrend=new Chart(qs("#chart-trend"),{ type:"line", data:{ labels:lab, datasets:[{ data:dat }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});

    var N=Math.min(Math.max(parseInt(topNEl.value||"7",10),3),15), by={}, i;
    for(i=0;i<items.length;i++){ var c=items[i].champion||"Unknown"; if(!by[c]) by[c]={g:0,w:0}; by[c].g++; if(items[i].win) by[c].w++; }
    var champs=Object.keys(by).map(function(k){return [k,by[k]];}).sort(function(a,b){return b[1].g-a[1].g;}).slice(0,N);
    if(chartChamps) chartChamps.destroy();
    chartChamps=new Chart(qs("#chart-champs"),{ type:"bar", data:{ labels:champs.map(function(x){return x[0];}), datasets:[{ data:champs.map(function(x){var s=x[1]; return Math.round(s.w/s.g*100); }) }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});

    var kds=items.map(function(m){ var mch=(m.kda||'').match(/^(\d+)\/(\d+)\/(\d+)/)||[]; var k=+mch[1]||0, d=+mch[2]||0, a=+mch[3]||0; return d===0?(k+a):(k+a)/d; }).filter(function(v){return isFinite(v);});
    function bp(arr){ if(!arr.length) return {min:0,q1:0,median:0,q3:0,max:0}; var a=arr.slice().sort(function(x,y){return x-y;}), q=function(p){ return a[Math.floor((a.length-1)*p)]; }; return {min:a[0],q1:q(.25),median:q(.5),q3:q(.75),max:a[a.length-1]}; }
    try{
      if(chartKDA) chartKDA.destroy();
      chartKDA=new Chart(qs("#chart-kda"),{ type:"boxplot", data:{ labels:["KDA"], datasets:[{ data:[bp(kds)] }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});
    }catch(e){
      var bins=[0,1,2,3,4,5,7,10], hist=new Array(bins.length-1); var j; for(j=0;j<hist.length;j++) hist[j]=0;
      kds.forEach(function(v){ for(j=0;j<bins.length-1;j++){ if(v>=bins[j] && v<bins[j+1]){ hist[j]++; break; } } });
      if(chartKDA) chartKDA.destroy();
      chartKDA=new Chart(qs("#chart-kda"),{ type:"bar", data:{ labels:bins.slice(0,-1).map(function(b,ii){return b+"–"+bins[ii+1];}), datasets:[{ data:hist }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});
    }

    /* 라인별 승률 추이 (누적 WR) */
    var byRole = {TOP:[],JUNGLE:[],MIDDLE:[],BOTTOM:[],UTILITY:[]};
    var acc = {TOP:{w:0,c:0},JUNGLE:{w:0,c:0},MIDDLE:{w:0,c:0},BOTTOM:{w:0,c:0},UTILITY:{w:0,c:0}};
    var labsRT = [];
    sorted.forEach(function(m,idx){
      var r=(m.role||"").toUpperCase();
      if(acc[r]){ acc[r].c++; if(m.win) acc[r].w++; }
      labsRT.push(idx+1);
      Object.keys(byRole).forEach(function(k){
        var a=acc[k]; byRole[k].push(a.c? Math.round(a.w/a.c*100) : 0);
      });
    });
    var roleSets = Object.keys(byRole).map(function(k){ return { label:k, data:byRole[k] }; });
    if(chartRoleTrend) chartRoleTrend.destroy();
    chartRoleTrend=new Chart(qs("#chart-role-trend"),{ type:"line", data:{ labels:labsRT, datasets:roleSets }, options:{ plugins:{legend:{display:true}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});

    /* 히트맵 (플러그인 미존재 시 폴백) */
    var queues=["RANKED_SOLO_5x5","RANKED_FLEX_SR","ARAM","NORMAL"];
    var topMap={}, m2;
    for(i=0;i<items.length;i++){ m2=items[i]; topMap[m2.champion||"Unknown"]=(topMap[m2.champion||"Unknown"]||0)+1; }
    var topChamps=Object.keys(topMap).map(function(k){return [k,topMap[k]];}).sort(function(a,b){return b[1]-a[1];}).slice(0,10).map(function(x){return x[0];});
    var kdaBy={}, ci, qi;
    for(ci=0;ci<topChamps.length;ci++){ var cc=topChamps[ci]; kdaBy[cc]={}; for(qi=0;qi<queues.length;qi++) kdaBy[cc][queues[qi]]=[]; }
    for(i=0;i<items.length;i++){
      m2=items[i]; var ccc=m2.champion||"Unknown"; if(topChamps.indexOf(ccc)===-1) continue;
      var q=(m2.queueType || (m2.gameMode==="CLASSIC" ? "NORMAL" : "NORMAL")); var mch2=(m2.kda||'').match(/^(\d+)\/(\d+)\/(\d+)/)||[]; var kk=+mch2[1]||0, dd=+mch2[2]||0, aa=+mch2[3]||0; var val= dd===0 ? (kk+aa) : (kk+aa)/dd;
      if(queues.indexOf(q)===-1) q="NORMAL"; kdaBy[ccc][q].push(val);
    }
    var axes=heatAxesSel.value, dataMat=[], xL=[], yL=[];
    function avg(arr){ if(!arr.length) return 0; var s=0; var t; for(t=0;t<arr.length;t++) s+=arr[t]; return Math.round((s/arr.length)*100)/100; }
    if(axes==="champ-queue"){
      xL=queues; yL=topChamps;
      yL.forEach(function(cy, y){ xL.forEach(function(qx, x){ dataMat.push({x:x,y:y,v:avg(kdaBy[cy][qx])}); }); });
    } else {
      xL=topChamps; yL=queues;
      yL.forEach(function(qy, y){ xL.forEach(function(cx, x){ dataMat.push({x:x,y:y,v:avg(kdaBy[cx][qy])}); }); });
    }
    var hasMatrix = Chart && Chart.registry && Chart.registry.getController && Chart.registry.getController("matrix");
    try{
      if(!hasMatrix) throw new Error("matrix plugin not loaded");
      if(chartHeatmap) chartHeatmap.destroy();
      chartHeatmap=new Chart(qs("#chart-heatmap"),{
        type:"matrix",
        data:{ datasets:[{ data:dataMat, width:function(ctx){ var w=(ctx.chart.chartArea&&ctx.chart.chartArea.width)||360; return w/xL.length-6; }, height:function(ctx){ var h=(ctx.chart.chartArea&&ctx.chart.chartArea.height)||200; return h/yL.length-6; }, backgroundColor:function(ctx){ var v=ctx.raw.v||0; return chartColors().heat(v); }, borderColor:chartColors().grid, borderWidth:1 }]},
        options:{ plugins:{legend:{display:false}, tooltip:{ callbacks:{ title:function(it){ return yL[it[0].raw.y]+" × "+xL[it[0].raw.x]; }, label:function(it){ return "KDA "+it.raw.v; } } } }, scales:{ x:{ ticks:{ color:chartColors().text, callback:function(v){ return xL[v]; } }, grid:{ display:false } }, y:{ ticks:{ color:chartColors().text, callback:function(v){ return yL[v]; } }, grid:{ display:false } } }
      });
    }catch(e){
      var grp={}, d; for(i=0;i<dataMat.length;i++){ d=dataMat[i]; var key = ''+yL[d.y]; (grp[key]||(grp[key]=[]))[d.x]=d.v; }
      var labels = Object.keys(grp);
      var datasets = xL.map(function(x,ix){ return { label:x, data: labels.map(function(l){ return (grp[l] && grp[l][ix]) ? grp[l][ix] : 0; }) }; });
      if(chartHeatmap) chartHeatmap.destroy();
      chartHeatmap=new Chart(qs("#chart-heatmap"),{ type:"bar", data:{ labels:labels, datasets:datasets }, options:{ responsive:true, plugins:{legend:{display:true}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } });
    }

    var byHour=[], h; for(h=0;h<24;h++) byHour.push({w:0,c:0});
    items.forEach(function(m3){ var hh=new Date(m3.timestamp||0).getHours(); byHour[hh].c++; if(m3.win) byHour[hh].w++; });
    var wr=byHour.map(function(x){ return x.c ? Math.round(x.w/x.c*100) : 0; });
    if(chartHourly) chartHourly.destroy();
    chartHourly=new Chart(qs("#chart-hourly"),{ type:"bar", data:{ labels: Array(24).fill(0).map(function(_,i){return i+":00";}), datasets:[{ data:wr }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:C.text}}, y:{ticks:{color:C.text}} } }});

    renderItemsCloud(items);
    renderItemClusters(items);
    renderRoleKDATable(items);
  }

  function renderList(data, filter){
    filter = filter || currentFilter;
    var s=data.summoner||{}, r=data.rank||{}; var items=data.summary||[];
    if(filter!=="ALL"){
      items = items.filter(function(m){
        if(filter==="RANKED_SOLO_5x5") return m.queueType==="RANKED_SOLO_5x5";
        if(filter==="RANKED_FLEX_SR") return m.queueType==="RANKED_FLEX_SR";
        if(filter==="NORMAL") return m.gameMode==="CLASSIC" && !m.queueType;
        if(filter==="ARAM") return m.gameMode==="ARAM";
        return true;
      });
    }
    if(Array.isArray(window._accum)) items=[].concat(items); // 복제
    window._accum=items;

    renderKPIs(items);

    var list = items.map(function(m){
      var champ=m.champion||"-"; var icon="https://ddragon.leagueoflegends.com/cdn/"+DDRAGON_VER+"/img/champion/"+champ+".png";
      return '<li class="flex gap-3 items-center p-3 rounded-xl border" style="border-color:var(--line)">'+
             '<img src="'+icon+'" alt="'+safe(champ)+'" class="w-10 h-10 rounded-lg" onerror="this.style.display=\'none\'">'+
             '<div class="flex-1 min-w-0">'+
             '<div class="truncate"><b>'+(m.win?"승":"패")+'</b> · '+safe(m.gameMode||"-")+' · '+safe(champ)+' · <span class="muted">'+timeAgo(m.timestamp)+'</span></div>'+
             '<div class="muted text-sm knum">KDA '+safe(m.kda)+' · CS '+safe(m.cs||0)+' · '+fmtT(m.time||0)+'</div>'+
             '</div></li>';
    }).join("");

    window._raw=data;
    out.innerHTML =
      '<div class="flex items-start justify-between gap-3 mb-3">'+
        '<div><h2 class="text-xl font-extrabold">'+safe(s.name||"-")+'</h2><div class="muted text-sm">'+T("cached")+'</div></div>'+
        '<div class="grid grid-cols-2 gap-2 min-w-[240px]">'+
          '<div class="p-2 rounded-xl border" style="border-color:var(--line)"><div class="muted text-xs mb-1">솔로랭크</div><div class="text-sm">'+rankLine(r.solo)+'</div></div>'+
          '<div class="p-2 rounded-xl border" style="border-color:var(--line)"><div class="muted text-xs mb-1">자유랭크</div><div class="text-sm">'+rankLine(r.flex)+'</div></div>'+
        '</div>'+
      '</div>'+
      '<ul class="space-y-2">'+(list || '<li class="muted">'+T("empty")+'</li>')+'</ul>';

    renderCharts(items);
    moreBtn.disabled=false;
  }

  /* recent search UI */
  function pushRecent(name){
    if(!name) return;
    var i=RECENTS.indexOf(name);
    if(i>=0) RECENTS.splice(i,1);
    RECENTS.unshift(name);
    if(RECENTS.length>10) RECENTS.length=10;
    try{ localStorage.setItem(STORAGE.hist, JSON.stringify(RECENTS)); }catch(e){}
    renderRecent();
  }
  function renderRecent(){
    if(!recentBox) return;
    if(!RECENTS.length){ recentBox.innerHTML='<div class="px-3 py-2 muted text-sm">'+T("none")+'</div>'; return; }
    recentBox.innerHTML = RECENTS.map(function(n){
      return '<button class="w-full text-left px-3 py-2 rounded hover:bg-black/10 recent-item" data-name="'+safe(n)+'">'+safe(n)+'</button>';
    }).join('') + '<hr class="my-2 border-t" style="border-color:var(--line)"><button id="btn-clear-recent" class="w-full text-left px-3 py-2 rounded hover:bg-black/10">최근검색 비우기</button>';
  }
  renderRecent();
  recentBox.addEventListener("click", function(e){
    var t=e.target; var n=t && t.getAttribute && t.getAttribute("data-name");
    if(n){ input.value=n; recentToggle.removeAttribute("open"); form.dispatchEvent(new Event("submit")); return; }
    if(t && t.id==="btn-clear-recent"){ RECENTS=[]; try{ localStorage.setItem(STORAGE.hist,"[]"); }catch(x){} renderRecent(); }
  });
  input.addEventListener("focus", function(){ if(RECENTS.length) recentToggle.setAttribute("open","true"); });
  input.addEventListener("blur", function(){ setTimeout(function(){ recentToggle.removeAttribute("open"); },150); });

  /* events */
  form.addEventListener("submit", function(e){
    e.preventDefault();
    var name=(input.value||"").trim();
    if(!name) return;
    currentName=name;
    loadedCount=0;
    window._accum=[];
    pushRecent(name);
    renderLoading();
    fetchProfile(name,5,currentFilter,0)
      .then(function(data){
        loadedCount += (data.summary||[]).length;
        renderList(data);
      })
      .catch(function(err){
        renderError(T("errLoad"), String(err && err.message ? err.message : err));
      });
  });

  filterBar.addEventListener("click", function(e){
    var target = e.target;
    var b = null;
    while (target && target !== filterBar) {
      if (target.getAttribute && target.getAttribute("data-filter")) { b = target; break; }
      target = target.parentNode;
    }
    if(!b) return;
    currentFilter = b.getAttribute("data-filter");
    setChips();
    if(window._raw) renderList(window._raw, currentFilter);
  });

  topNEl.addEventListener("change", function(){
    if(window._accum && window._accum.length) renderCharts(window._accum);
  });

  heatAxesSel.addEventListener("change", function(){
    try { localStorage.setItem(STORAGE.heatAxes, heatAxesSel.value); } catch(e){}
    if(window._accum) renderCharts(window._accum);
  });

  document.getElementById("btn-save-charts").addEventListener("click", function(){
    qsa("canvas").forEach(function(cv,i){
      try{
        var url=cv.toDataURL("image/png");
        var a=document.createElement("a");
        a.href=url;
        a.download="thunder_chart_"+(i+1)+".png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){}
    });
  });

  document.getElementById("btn-export").addEventListener("click", function(){
    if(!(window._accum && window._accum.length)) return;
    var header=["matchId","mode","queue","champion","win","k","d","a","kda","cs","timeSec","timestamp","role","items"];
    var rows=window._accum.map(function(m){
      var mch=(m.kda||'').match(/^(\d+)\/(\d+)\/(\d+)/)||[];
      var k=+mch[1]||0, d=+mch[2]||0, a=+mch[3]||0;
      return [m.gameId,m.gameMode,m.queueType,m.champion,m.win?1:0,k,d,a,(m.kda||"").split(" ").slice(-1)[0],m.cs||0,m.time||0,m.timestamp||0,m.role||"", (m.items||[]).join("|")];
    });
    var csv=[header].concat(rows).map(function(r){
      return r.map(function(x){ return '"'+String(x).replace(/"/g,'""')+'"'; }).join(",");
    }).join("\n");
    var blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    var url=URL.createObjectURL(blob);
    var a=document.createElement("a");
    a.href=url;
    a.download="thunder_"+(currentName||"player").replace(/\W+/g,"_")+".csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("btn-share").addEventListener("click", function(){
    var u=new URL(location.href);
    if(currentName) u.searchParams.set("q", currentName);
    u.searchParams.set("queue", currentFilter);
    try{
      if(navigator.share){
        navigator.share({ title:"Thunder", url:u.toString() });
      }else{
        navigator.clipboard.writeText(u.toString());
        alert("링크 복사됨");
      }
    }catch(e){}
  });

  document.getElementById("btn-chart-theme").addEventListener("click", function(){
    CHART_THEME = CHART_THEME==="auto" ? "dark" : (CHART_THEME==="dark" ? "light" : "auto");
    try { localStorage.setItem(STORAGE.chartTheme, CHART_THEME); } catch(e){}
    qs("#chart-theme-code").textContent = CHART_THEME.toUpperCase();
    applyChartDefaults();
    if(window._accum) renderCharts(window._accum);
  });

  document.getElementById("btn-lang").addEventListener("click", function(){
    LANG = (LANG==="en") ? "ko" : "en";
    try { localStorage.setItem(STORAGE.lang, LANG); } catch(e){}
    qs("#lang-code").textContent = LANG.toUpperCase();
    if(window._raw) renderList(window._raw, currentFilter);
  });

  document.getElementById("btn-clear-cache").addEventListener("click", function(){
    try{
      localStorage.removeItem(STORAGE.hist);
      localStorage.removeItem(STORAGE.lang);
      localStorage.removeItem(STORAGE.chartTheme);
      localStorage.removeItem(STORAGE.heatAxes);
      alert("로컬 설정을 초기화했습니다.");
    }catch(e){}
  });

  document.getElementById("btn-more").addEventListener("click", function(){
    if(!currentName) return;
    var btn = document.getElementById("btn-more");
    btn.disabled = true;
    fetchProfile(currentName, 5, currentFilter, loadedCount)
      .then(function(data){
        loadedCount += (data.summary || []).length;
        if (window._accum) data.summary = [].concat(window._accum, (data.summary || []));
        renderList(data);
      })
      .catch(function(err){
        renderError(T("errLoad"), String(err && err.message ? err.message : err));
      })
      .then(function(){
        btn.disabled = false;
      });
  });

  document.getElementById("btn-health").addEventListener("click", function(){
    healthState.textContent="확인 중…";
    fetch(API_BASE+"/health")
      .then(function(r){ return r.text().then(function(t){ return {ok:r.ok, status:r.status, text:t}; }); })
      .then(function(p){
        healthState.textContent = p.ok ? ("OK: "+p.text) : ("ERR "+p.status+": "+p.text);
      })
      .catch(function(e){
        healthState.textContent = "요청 실패: "+(e && e.message ? e.message : e);
      });
  });

  /* 비교 모드 */
  function calcKPI(items){
    var wins=items.filter(function(m){return m.win;}).length, tot=items.length;
    var wr = tot? Math.round(wins/tot*100):0;
    var kd=items.map(function(m){ var mch=(m.kda||'').match(/^(\d+)\/(\d+)\/(\d+)/)||[]; var k=+mch[1]||0,d=+mch[2]||0,a=+mch[3]||0; return d===0?(k+a):(k+a)/d; });
    var kda = kd.length? Math.round((kd.reduce(function(s,v){return s+v;},0)/kd.length)*100)/100 : 0;
    var roles=["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"], out={};
    roles.forEach(function(r){ out[r]={w:0,c:0}; });
    items.forEach(function(m){ var r=(m.role||"").toUpperCase(); if(out[r]){ out[r].c++; if(m.win) out[r].w++; } });
    var roleWR = roles.map(function(r){ var o=out[r]; return o.c? Math.round(o.w/o.c*100):0; });
    var topRole="-", cnt=-1;
    Object.keys(out).forEach(function(r){ if(out[r].c>cnt){ cnt=out[r].c; topRole=r; } });
    return {wr:wr,kda:kda,roleWR:roleWR,topRole:topRole};
  }
  qs("#btn-compare-run").addEventListener("click", function(){
    var a=(qs("#summoner-a").value||"").trim(), b=(qs("#summoner-b").value||"").trim();
    if(!a || !b){ alert("두 소환사를 모두 입력하세요."); return; }
    var btn=this; btn.disabled=true;
    Promise.all([ fetchProfile(a,5,"ALL",0), fetchProfile(b,5,"ALL",0) ])
      .then(function(arr){
        var A=calcKPI(arr[0].summary||[]), B=calcKPI(arr[1].summary||[]);
        qs("#compare-summary").textContent = a+" vs "+b+" · 승률 "+A.wr+"%:"+B.wr+"% · KDA "+A.kda+":"+B.kda+" · 주포지션 "+A.topRole+" / "+B.topRole;
        if(chartCmp) chartCmp.destroy();
        chartCmp = new Chart(qs("#chart-compare"), {
          type:"bar",
          data:{ labels:["승률(%)","평균 KDA"], datasets:[ {label:a, data:[A.wr,A.kda]}, {label:b, data:[B.wr,B.kda]} ] },
          options:{ plugins:{legend:{display:true}} }
        });
        var roles=["TOP","JUNGLE","MIDDLE","BOTTOM","UTILITY"];
        if(chartCmpRole) chartCmpRole.destroy();
        chartCmpRole = new Chart(qs("#chart-compare-role"), {
          type:"bar",
          data:{ labels:roles, datasets:[ {label:a, data:A.roleWR}, {label:b, data:B.roleWR} ] },
          options:{ plugins:{legend:{display:true}} }
        });
      })
      .catch(function(err){ qs("#compare-summary").textContent = "비교 실패: "+String(err && err.message ? err.message : err); })
      .then(function(){ btn.disabled=false; });
  });

  /* URL init */
  (function(){
    var p=new URL(location.href).searchParams;
    var q=p.get("q");
    var queue=p.get("queue");
    if(queue){
      currentFilter=String(queue).toUpperCase();
      setChips();
    }
    if(q){
      input.value=q;
      try{
        if(form.requestSubmit){ form.requestSubmit(); }
        else { form.dispatchEvent(new Event("submit")); }
      }catch(e){
        form.dispatchEvent(new Event("submit"));
      }
    }else{
      setChips();
    }
  })();
  </script>
</body>
  </html>
